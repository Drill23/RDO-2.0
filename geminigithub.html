<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Visualizador de Rendimento Otimizado</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.9.2/html2pdf.bundle.min.js"></script>
    <style>
        /* Define color palette using CSS variables */
        :root {
            --primary-bg: #f4f7f6;
            --secondary-bg: #ffffff;
            --header-bg: #e9ecef;
            --table-header-bg: #dee2e6;
            --button-blue: #007bff;
            --button-blue-hover: #0056b3;
            --button-green: #28a745;
            --button-green-hover: #1e7e34;
            --button-yellow: #ffc107;
            --button-yellow-hover: #d39e00;
            --button-purple: #6f42c1;
            --button-purple-hover: #5a32a3;
            --button-purple-light: #9d78db; /* For Semanal T1 */
            --button-purple-light-hover: #8a5fcf;
            --button-purple-dark: #4d2d8a; /* For Semanal T2 */
            --button-purple-dark-hover: #3e2177;
            --button-blue-dark: #0d6efd; /* Exemplo para Mensal T1 */
            --button-blue-dark-hover: #0b5ed7;
            --button-green-dark: #198754; /* Exemplo para Mensal T2 */
            --button-green-dark-hover: #157347;
            --button-orange: #fd7e14; /* Exemplo para Comparar Mês */
            --button-orange-hover: #d96a0d;
            /* --- NOVAS CORES PARA MULTI-DIA --- */
            --button-cyan: #17a2b8; /* Para Comparar Dias T1 */
            --button-cyan-hover: #117a8b;
            --button-teal: #20c997; /* Para Comparar Dias T2 */
            --button-teal-hover: #19a17a;
            /* --- FIM NOVAS CORES --- */
            --button-grey: #6c757d;
            --button-grey-hover: #545b62;
            --button-red: #dc3545; /* PDF Export */
            --button-red-hover: #bd2130;
            --text-color: #333;
            --positive: #28a745; /* Green */
            --negative: #dc3545; /* Red */
            --border-color: #dee2e6;
            --na-meta: #6c757d; /* Grey for 'Na Meta' or neutral */
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 0;
            background-color: var(--primary-bg);
            color: var(--text-color);
            line-height: 1.6;
        }

        .container {
            max-width: 1350px;
            margin: 20px auto;
            padding: 20px;
            background-color: var(--secondary-bg);
            box-shadow: 0 0 15px rgba(0, 0, 0, 0.1);
            border-radius: 8px;
        }

        h1 {
            text-align: center;
            color: var(--button-blue);
            margin-bottom: 30px;
            page-break-after: avoid;
        }

        .menu, .acoes {
            text-align: center;
            margin-bottom: 30px;
        }
        .menu-section {
            margin-bottom: 15px;
            padding-bottom: 15px;
            border-bottom: 1px solid var(--border-color);
        }
         .menu-section:last-child {
             border-bottom: none;
             margin-bottom: 0;
             padding-bottom: 0;
         }
         .menu-section h3 {
            margin-bottom: 10px;
            color: var(--button-grey);
            font-size: 1.1em;
            font-weight: 600;
         }

        button {
            padding: 10px 20px;
            margin: 5px;
            font-size: 15px;
            cursor: pointer;
            border: none;
            border-radius: 5px;
            color: white;
            transition: background-color 0.3s ease, opacity 0.3s ease; /* Add opacity transition */
            vertical-align: middle;
        }
        button:hover { opacity: 0.9; }
        /* Style for disabled button */
        button:disabled {
             background-color: var(--button-grey) !important; /* Use grey background */
             cursor: not-allowed; /* Change cursor */
             opacity: 0.6; /* Make it look faded */
        }


        /* Button Styles */
        .btn-turno1 { background-color: var(--button-blue); }
        .btn-turno1:hover:not(:disabled) { background-color: var(--button-blue-hover); } /* Apply hover only if not disabled */
        .btn-turno2 { background-color: var(--button-green); }
        .btn-turno2:hover:not(:disabled) { background-color: var(--button-green-hover); }
        .btn-comparar-dia { background-color: var(--button-yellow); color: #333; }
        .btn-comparar-dia:hover:not(:disabled) { background-color: var(--button-yellow-hover); }
        .btn-semanal-t1 { background-color: var(--button-purple-light); }
        .btn-semanal-t1:hover:not(:disabled) { background-color: var(--button-purple-light-hover); }
        .btn-semanal-t2 { background-color: var(--button-purple-dark); }
        .btn-semanal-t2:hover:not(:disabled) { background-color: var(--button-purple-dark-hover); }
        .btn-comparar-semana { background-color: var(--button-purple); }
        .btn-comparar-semana:hover:not(:disabled) { background-color: var(--button-purple-hover); }
        .btn-mensal-t1 { background-color: var(--button-blue-dark); }
        .btn-mensal-t1:hover:not(:disabled) { background-color: var(--button-blue-dark-hover); }
        .btn-mensal-t2 { background-color: var(--button-green-dark); }
        .btn-mensal-t2:hover:not(:disabled) { background-color: var(--button-green-dark-hover); }
        .btn-comparar-mes { background-color: var(--button-orange); }
        .btn-comparar-mes:hover:not(:disabled) { background-color: var(--button-orange-hover); }
        /* --- NOVOS BOTÕES MULTI-DIA --- */
        .btn-multi-dia-t1 { background-color: var(--button-cyan); }
        .btn-multi-dia-t1:hover:not(:disabled) { background-color: var(--button-cyan-hover); }
        .btn-multi-dia-t2 { background-color: var(--button-teal); }
        .btn-multi-dia-t2:hover:not(:disabled) { background-color: var(--button-teal-hover); }
        /* --- FIM NOVOS BOTÕES --- */
        .btn-pdf { background-color: var(--button-red); }
        .btn-pdf:hover:not(:disabled) { background-color: var(--button-red-hover); }
        .btn-voltar { background-color: var(--button-grey); }
        .btn-voltar:hover:not(:disabled) { background-color: var(--button-grey-hover); }

        #seletorPeriodo {
             text-align: center;
             margin-bottom: 20px;
             padding: 15px;
             background-color: var(--header-bg);
             border-radius: 5px;
        }
        #seletorPeriodo label {
            margin: 0 10px 0 5px;
            font-weight: 500;
        }
        #seletorPeriodo input[type="date"], #seletorPeriodo select {
             padding: 8px;
             margin-right: 10px;
             border: 1px solid var(--border-color);
             border-radius: 4px;
             font-size: 0.95em;
        }
        #seletorPeriodo button {
             padding: 8px 15px;
             font-size: 0.95em;
             margin-left: 5px;
        }

        /* --- NOVO SELETOR MULTI-DIA --- */
        #seletorMultiDiaContainer {
             margin-top: 15px;
             text-align: left; /* Alinha o label geral à esquerda */
        }
        #seletorMultiDiaContainer > label { /* Estilo para o label principal */
            display: block; /* Faz o label ocupar a linha toda */
            margin-bottom: 8px; /* Espaço abaixo do label */
            font-weight: 500;
            text-align: center; /* Centraliza o texto do label principal */
        }
        #seletorMultiDia {
             max-height: 200px; /* Altura máxima para a lista de dias */
             overflow-y: auto; /* Adiciona scroll se necessário */
             padding: 10px;
             border: 1px solid var(--border-color);
             background-color: var(--secondary-bg);
             border-radius: 4px;
             text-align: left; /* Alinha checkboxes à esquerda dentro da div */
        }
        #seletorMultiDia div { /* Estilo para cada linha de checkbox */
             margin-bottom: 5px;
             display: block; /* Garante que cada checkbox fique em uma linha */
        }
        #seletorMultiDia label { /* Label do checkbox individual */
            margin-left: 8px; /* Espaço entre checkbox e label */
            cursor: pointer;
            font-weight: normal; /* Reset para label padrão */
            vertical-align: middle; /* Alinha texto com checkbox */
        }
        #seletorMultiDia input[type="checkbox"] {
            cursor: pointer;
            vertical-align: middle;
        }
        .checkbox-limit-message {
            font-size: 0.9em;
            color: var(--button-grey);
            margin-top: 10px;
            display: block; /* Garante que fique abaixo */
            text-align: center;
            font-weight: 500;
        }
        /* --- FIM NOVO SELETOR --- */


        .info {
            font-size: 1.2em;
            font-weight: bold;
            margin-bottom: 20px;
            padding: 15px;
            background-color: var(--header-bg);
            border-radius: 5px;
            text-align: center;
            page-break-after: avoid;
        }

        #status {
            text-align: center;
            font-style: italic;
            color: var(--button-grey);
            margin: 20px;
            min-height: 1.2em; /* Evita que a página pule quando a mensagem some */
        }

        .content-area {
            background-color: #fff;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
            margin-top: 20px;
            position: relative;
            /* page-break-inside: avoid; */ /* Might be too restrictive */
        }

        table {
            margin: 20px auto;
            border-collapse: collapse;
            width: 100%;
            background: #fff;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            border-radius: 5px;
            overflow: hidden;
            font-size: 0.9em;
            border-spacing: 0;
            page-break-inside: auto;
        }
        tr { page-break-inside: avoid !important; page-break-after: auto; }
        thead { display: table-header-group; }
        tbody { display: table-row-group; }

        th, td {
            border: 1px solid var(--border-color);
            padding: 8px 10px;
            text-align: left;
            vertical-align: middle;
        }
        th {
            background-color: var(--table-header-bg);
            font-weight: bold;
            text-transform: uppercase;
            font-size: 0.8em;
            letter-spacing: 0.05em;
            white-space: nowrap;
        }
        td:last-child, th:last-child { text-align: center; }
        td.numeric, th.numeric { text-align: right; white-space: nowrap; }
        td.center, th.center { text-align: center; }

        .positivo { color: var(--positive); font-weight: bold; }
        .negativo { color: var(--negative); font-weight: bold; }
        .na-meta { color: var(--na-meta); }

        .summary {
            margin-top: 20px;
            padding: 15px;
            background-color: #eef;
            border-left: 5px solid var(--button-blue);
            border-radius: 4px;
            font-size: 1.1em;
            page-break-before: auto;
            page-break-inside: avoid !important;
        }
         .summary strong { color: var(--button-blue); }

        .chart-container {
             position: relative;
             margin: auto;
             margin-top: 30px;
             height: 40vh; /* Pode precisar ajustar dependendo dos dados */
             width: 95%;
             background: #fff;
             padding: 15px;
             border-radius: 5px;
             box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
             display: block !important;
             page-break-inside: avoid !important;
             page-break-before: auto;
             overflow: hidden;
        }
        /* --- NOVO CONTAINER DE GRÁFICO --- */
        #graficoMultiDiaContainer {
            /* Usa os mesmos estilos do chart-container */
        }

        canvas {
            display: block;
            max-width: 100%;
            max-height: 100%;
            width: auto !important;
            height: auto !important;
        }

        .acoes-visao {
            text-align: center;
            margin-top: 30px;
            padding-top: 20px;
            border-top: 1px solid var(--border-color);
            page-break-before: avoid;
        }

        /* Styles specifically for PDF generation */
        @media print {
           body {
               -webkit-print-color-adjust: exact !important;
               color-adjust: exact !important;
               font-size: 9pt;
           }
           .container { box-shadow: none; border: none; margin: 0; max-width: 100%; }
           button, .menu, .acoes, #seletorPeriodo { display: none !important; } /* Hide selectors too */
           .content-area { box-shadow: none; border: none; padding: 0; margin: 0; }
           .chart-container { height: 35vh; width: 100%; padding: 5px; }
           .chart-container, .summary, tr { page-break-inside: avoid !important; }
           h1, .info { page-break-after: avoid; }
           .acoes-visao { display: none !important; }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>📊 Visualizador de Rendimento Otimizado</h1>

        <div class="menu">
             <div class="menu-section">
                <h3>Análise Diária</h3>
                <button class="btn-turno1" onclick="selecionarPeriodo('diario1')">🔵 Diário T1</button>
                <button class="btn-turno2" onclick="selecionarPeriodo('diario2')">🟢 Diário T2</button>
                <button class="btn-comparar-dia" onclick="selecionarPeriodo('comparar_dia')">🟡 Comparar Dia</button>
                <!-- NOVOS BOTÕES -->
                <button class="btn-multi-dia-t1" onclick="selecionarPeriodo('comparar_dias_t1')">🌀 Comparar Dias T1</button>
                <button class="btn-multi-dia-t2" onclick="selecionarPeriodo('comparar_dias_t2')">✳️ Comparar Dias T2</button>
                 <!-- FIM NOVOS BOTÕES -->
            </div>
            <div class="menu-section">
                <h3>Análise Semanal</h3>
                <button class="btn-semanal-t1" onclick="selecionarPeriodo('semanal1')">🟣 Semanal T1</button>
                <button class="btn-semanal-t2" onclick="selecionarPeriodo('semanal2')">🟣 Semanal T2</button>
                <button class="btn-comparar-semana" onclick="selecionarPeriodo('comparar_semana')">🟣 Comparar Semana</button>
            </div>
            <div class="menu-section">
                <h3>Análise Mensal</h3>
                <button class="btn-mensal-t1" onclick="selecionarPeriodo('mensal1')">🟦 Mensal T1</button>
                <button class="btn-mensal-t2" onclick="selecionarPeriodo('mensal2')">🟩 Mensal T2</button>
                <button class="btn-comparar-mes" onclick="selecionarPeriodo('comparar_mes')">🟧 Comparar Mês</button>
            </div>
        </div>

        <!-- Área de Seleção de Período (Inicialmente Oculta) -->
        <div id="seletorPeriodo" style="display:none;">
             <h4>Selecione o Período para <span id="tipoAnaliseSelecionada">Análise</span>:</h4>
             <div id="seletorData" style="display:none;">
                 <label for="inputData">Data:</label>
                 <input type="date" id="inputData" name="inputData">
             </div>
             <div id="seletorSemana" style="display:none;">
                 <label for="selectSemana">Semana:</label>
                 <select id="selectSemana">
                     <option value="">Carregando...</option>
                 </select>
             </div>
             <div id="seletorMes" style="display:none;">
                 <label for="selectAnoMes">Ano:</label>
                 <select id="selectAnoMes">
                      <option value="">Carregando...</option>
                 </select>
                 <label for="selectMes">Mês:</label>
                 <select id="selectMes">
                     <option value="">Selecione o Ano</option>
                 </select>
             </div>
             <!-- NOVO SELETOR MULTI-DIA -->
             <div id="seletorMultiDiaContainer" style="display:none;">
                 <label>Dias Disponíveis (Selecione de 2 a 4):</label>
                 <div id="seletorMultiDia">
                     <!-- Checkboxes serão inseridos aqui pelo JS -->
                     <p>Carregando dias disponíveis...</p>
                 </div>
                 <span id="checkboxLimitMessage" class="checkbox-limit-message"></span>
             </div>
             <!-- FIM NOVO SELETOR -->
             <button id="btnCarregarDados" class="btn-turno1" onclick="carregarDadosSelecionados()">Carregar Dados</button> <!-- Adicionado ID ao botão -->
             <button class="btn-voltar" onclick="cancelarSelecao()">Cancelar</button>
        </div>

        <div id="info" class="info" style="display:none;"></div>
        <div id="status">⏳ Carregando manifesto de arquivos...</div>
        <div class="acoes">
             <button class="btn-voltar voltar" onclick="voltarMenu()" style="display:none;">🔙 Voltar ao Menu Principal</button>
        </div>

        <div class="content-area" id="contentArea" style="display:none;">
            <!-- Info Title (prepended by JS for PDF) -->
            <div id="resultado"></div> <!-- Table and Summary here -->

            <!-- Chart Containers -->
            <div id="graficoIndividualContainer" class="chart-container" style="display:none;">
                 <canvas id="graficoIndividual"></canvas>
            </div>
            <div id="graficoComparativoContainer" class="chart-container" style="display:none;">
                 <canvas id="graficoComparativo"></canvas>
            </div>
             <!-- NOVO CONTAINER DE GRÁFICO -->
            <div id="graficoMultiDiaContainer" class="chart-container" style="display:none;">
                 <canvas id="graficoMultiDia"></canvas>
            </div>
             <!-- FIM NOVO CONTAINER -->

             <!-- Actions specific to the current view -->
             <div class="acoes-visao">
                 <button class="btn-pdf btn-pdf-visao" onclick="exportarPDF_VisaoAtual()" style="display:none;">📄 Exportar Esta Visão em PDF</button>
             </div>
        </div>

    </div>

<script>
    // --- Variáveis Globais e Constantes ---
    let dados = {};
    let arquivosDisponiveis = [];
    let tipoAnaliseAtual = null;
    let graficoComparativoInstancia = null;
    let graficoIndividualInstancia = null;
    let graficoMultiDiaInstancia = null;
    let currentChartType = '';
    const MAX_MULTI_DAY_SELECTION = 4;
    const MIN_MULTI_DAY_SELECTION = 2;

    // --- Funções Utilitárias ---
    function destruirGraficos() {
        if (graficoComparativoInstancia) { graficoComparativoInstancia.destroy(); graficoComparativoInstancia = null; }
        if (graficoIndividualInstancia) { graficoIndividualInstancia.destroy(); graficoIndividualInstancia = null; }
        if (graficoMultiDiaInstancia) { graficoMultiDiaInstancia.destroy(); graficoMultiDiaInstancia = null; }
        document.getElementById("graficoComparativoContainer").style.display = "none";
        document.getElementById("graficoIndividualContainer").style.display = "none";
        document.getElementById("graficoMultiDiaContainer").style.display = "none";
    }

    function extrairInfo(nomeArquivo) {
        if (!nomeArquivo) return { nome: 'N/A', tipo: 'N/A', diaSemana: 'N/A', data: 'N/A', turno: 'N/A', mes: 'N/A', ano: 'N/A', tituloPeriodo: 'N/A', dataObj: null };
        const partes = nomeArquivo.replace('.json', '').split('.');
        let tipo = 'N/A', turno = 'N/A', diaSemana = 'N/A', data = 'N/A', tituloPeriodo = 'N/A', mes = 'N/A', ano = 'N/A', periodoSemana = 'N/A', dataObj = null;

        turno = partes.includes("turno1") ? "Turno 1" : (partes.includes("turno2") ? "Turno 2" : "N/A");

        try {
            if (partes[0] === "semana" && partes.length >= 5) {
                tipo = "semanal";
                periodoSemana = partes[1].replace('a', ' a ');
                mes = partes[2];
                ano = "20" + partes[3];
                tituloPeriodo = `Semana de ${periodoSemana.split(' a ')[0]} a ${periodoSemana.split(' a ')[1]}/${mes}/${ano}`;
                data = `${mes}/${ano}`;
                const primeiroDiaSemana = parseInt(periodoSemana.split(' a ')[0]);
                dataObj = new Date(Date.UTC(parseInt(ano), parseInt(mes) - 1, primeiroDiaSemana));
            } else if (partes[0] === "mensal" && partes.length >= 4) {
                tipo = "mensal";
                mes = partes[1];
                ano = "20" + partes[2];
                const nomeMes = new Date(Date.UTC(parseInt(ano), parseInt(mes) - 1, 1)).toLocaleString('pt-BR', { month: 'long', timeZone: 'UTC' });
                tituloPeriodo = `${nomeMes.charAt(0).toUpperCase() + nomeMes.slice(1)}/${ano}`;
                data = `${mes}/${ano}`;
                dataObj = new Date(Date.UTC(parseInt(ano), parseInt(mes) - 1, 1));
            } else if (partes.length >= 5) {
                 tipo = "diario";
                 let diaNome = partes[0];
                 let offset = 0;
                 if (partes[1] === "feira") {
                     diaSemana = diaNome.charAt(0).toUpperCase() + diaNome.slice(1) + "-feira";
                     offset = 1;
                 } else {
                     diaSemana = diaNome.charAt(0).toUpperCase() + diaNome.slice(1);
                 }
                 const diaNum = partes[1 + offset];
                 mes = partes[2 + offset];
                 ano = "20" + partes[3 + offset];
                 data = `${diaNum}/${mes}/${ano}`;
                 tituloPeriodo = `${diaSemana}, ${data}`;
                 dataObj = new Date(Date.UTC(parseInt(ano), parseInt(mes) - 1, parseInt(diaNum)));
            }
        } catch (e) {
            console.error(`Erro ao parsear data para ${nomeArquivo}:`, e);
            return { nome: nomeArquivo, tipo, diaSemana, data, turno, mes, ano, periodoSemana, tituloPeriodo, dataObj: null };
        }
        if (dataObj instanceof Date && isNaN(dataObj.getTime())) {
             console.warn(`Data inválida criada para ${nomeArquivo}`);
             dataObj = null;
        }
        return { nome: nomeArquivo, tipo, diaSemana, data, turno, mes, ano, periodoSemana, tituloPeriodo, dataObj };
    }

    function commonChartOptions(titleText) {
        return {
            responsive: true, maintainAspectRatio: false,
            plugins: {
                legend: { position: 'top' },
                title: { display: true, text: titleText, font: { size: 16 } },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            let label = context.dataset.label || '';
                            if (label) { label += ': '; }
                            if (context.parsed.y !== null && !isNaN(context.parsed.y)) {
                                label += context.parsed.y.toFixed(3) + '%';
                            } else { label += 'N/D'; }
                            return label;
                        }
                    }
                }
            },
            scales: {
                y: { beginAtZero: true, ticks: { callback: value => value + '%' }, title: { display: true, text: 'Percentual (%)' } },
                x: { ticks: { autoSkip: false, maxRotation: 70, minRotation: 0 } }
            },
            animation: { duration: 500 }
        };
    }

    // --- Funções de Exibição ---
    function mostrarCabecalho(infos, tipo = 'individual') {
        const div = document.getElementById("info");
        let titulo = "";
        if (!Array.isArray(infos)) { infos = [infos]; }
        if (infos.length === 0 || !infos[0]) {
             div.innerHTML = "ℹ️ Informação do Período Indisponível"; div.style.display = 'block'; return;
        }
        const infoBase = infos[0];

        if (tipo === 'comparativo_multi_dia') {
            const turno = infoBase.turno;
            const turnoIcone = turno === 'Turno 1' ? '🌀' : '✳️';
            const datasOrdenadas = infos.filter(info => info.dataObj).sort((a, b) => a.dataObj - b.dataObj).map(info => info.data);
            titulo = `📊 Comparativo Multi-Dia (${turnoIcone} ${turno})<br>Dias: ${datasOrdenadas.join(', ')}`;
        } else if (tipo === 'comparativo' && infos.length === 2) {
            const [info1, info2] = infos;
            let tipoRelatorio = info1.tipo ? info1.tipo.charAt(0).toUpperCase() + info1.tipo.slice(1) : 'N/A';
            const icone1 = info1.turno === 'Turno 1' ? '🔵' : '🟢';
            const icone2 = info2.turno === 'Turno 1' ? '🔵' : '🟢';
            titulo = `📊 Comparativo ${tipoRelatorio} (${info1.tituloPeriodo})<br>${icone1} ${info1.turno} vs ${icone2} ${info2.turno}`;
        } else {
            let tipoRelatorio = infoBase.tipo ? infoBase.tipo.charAt(0).toUpperCase() + infoBase.tipo.slice(1) : 'N/A';
            const corIcone = infoBase.turno === 'Turno 1' ? '🔵' : (infoBase.turno === 'Turno 2' ? '🟢' : '📄');
            titulo = `📄 Relatório ${tipoRelatorio} (${infoBase.tituloPeriodo})<br>${corIcone} ${infoBase.turno}`;
        }
        div.innerHTML = titulo; div.style.display = 'block';
    }

    function mostrarTabela(dadosTurno1, infoTurno1, modo = 'diarioIndividual', dadosTurno2 = null, infoTurno2 = null) {
        let html = "";
        const resultadoDiv = document.getElementById("resultado");
        const pdfButton = document.querySelector('.btn-pdf-visao');
        destruirGraficos();
        dadosTurno1 = Array.isArray(dadosTurno1) ? dadosTurno1 : [];
        dadosTurno2 = Array.isArray(dadosTurno2) ? dadosTurno2 : [];

        try {
            html = "<table><thead><tr><th>Produto</th>";
            const labels = []; const dadosGrafico1 = []; const dadosGrafico2 = [];

            if (modo === 'comparativo' && infoTurno1 && infoTurno2) {
                currentChartType = 'comparativo';
                html += `<th class="numeric">${infoTurno1.turno} (%)</th><th class="numeric">${infoTurno2.turno} (%)</th><th class="numeric">Dif. (%)</th><th class="numeric">Dif. (Kg)</th><th class="numeric">Dif. (Cx)</th><th class="center">🏆 Melhor Turno</th></tr></thead><tbody>`;
                let vitorias1 = 0, vitorias2 = 0, empates = 0;
                const todosProdutos = [...new Set([...dadosTurno1.map(i => i.produto), ...dadosTurno2.map(i => i.produto)])].sort();

                for (const produto of todosProdutos) {
                    const item1 = dadosTurno1.find(it => it.produto === produto); const item2 = dadosTurno2.find(it => it.produto === produto);
                    const r1 = parseFloat(item1?.realizado) || 0; const r2 = parseFloat(item2?.realizado) || 0;
                    const k1 = parseFloat(item1?.quilos) || 0; const k2 = parseFloat(item2?.quilos) || 0;
                    const c1 = parseFloat(item1?.caixas) || 0; const c2 = parseFloat(item2?.caixas) || 0;
                    html += `<tr><td>${produto}</td>`;
                    if (item1 && item2) {
                        const dP = r2 - r1; const dK = k2 - k1; const dC = Math.round(c2) - Math.round(c1);
                        let mT = "Empate 🤔"; let cM = "na-meta";
                        if (dP > 1e-4) { mT = `${infoTurno2.turno} ${infoTurno2.turno === 'Turno 1' ? '🔵' : '🟢'}`; vitorias2++; cM = 'positivo'; }
                        else if (dP < -1e-4) { mT = `${infoTurno1.turno} ${infoTurno1.turno === 'Turno 1' ? '🔵' : '🟢'}`; vitorias1++; cM = 'negativo'; }
                        else { empates++; }
                        const cDP = dP > 1e-4 ? 'positivo' : (dP < -1e-4 ? 'negativo' : 'na-meta');
                        const cDK = dK > 0 ? 'positivo' : (dK < 0 ? 'negativo' : 'na-meta');
                        const cDC = dC > 0 ? 'positivo' : (dC < 0 ? 'negativo' : 'na-meta');
                        html += `<td class="numeric">${r1.toFixed(3)}%</td><td class="numeric">${r2.toFixed(3)}%</td><td class="numeric ${cDP}">${dP >= 0 ? '+' : ''}${dP.toFixed(3)}%</td><td class="numeric ${cDK}">${dK >= 0 ? '+' : ''}${dK.toFixed(2)}</td><td class="numeric ${cDC}">${dC >= 0 ? '+' : ''}${dC}</td><td class="center ${cM}">${mT}</td>`;
                        labels.push(produto); dadosGrafico1.push(r1); dadosGrafico2.push(r2);
                    } else if (item1) {
                        html += `<td class="numeric">${r1.toFixed(3)}%</td><td class="center">-</td><td colspan="3" class="center"><i>Não produzido no ${infoTurno2.turno}</i></td><td class="center">${infoTurno1.turno} ${infoTurno1.turno === 'Turno 1' ? '🔵' : '🟢'}</td>`;
                        labels.push(produto); dadosGrafico1.push(r1); dadosGrafico2.push(NaN);
                    } else if (item2) {
                        html += `<td class="center">-</td><td class="numeric">${r2.toFixed(3)}%</td><td colspan="3" class="center"><i>Não produzido no ${infoTurno1.turno}</i></td><td class="center">${infoTurno2.turno} ${infoTurno2.turno === 'Turno 1' ? '🔵' : '🟢'}</td>`;
                        labels.push(produto); dadosGrafico1.push(NaN); dadosGrafico2.push(r2);
                    }
                    html += `</tr>`;
                }
                html += "</tbody></table>";
                html += `<div class="summary"><strong>Resumo Comparativo (${infoTurno1.tipo}):</strong><br>${infoTurno1.turno === 'Turno 1' ? '🔵' : '🟢'} ${infoTurno1.turno} venceu em ${vitorias1} produto(s).<br>${infoTurno2.turno === 'Turno 1' ? '🔵' : '🟢'} ${infoTurno2.turno} venceu em ${vitorias2} produto(s).<br>🤔 Empates em ${empates} produto(s).<br><strong>🏆 Vencedor Geral: ${vitorias1 > vitorias2 ? infoTurno1.turno : (vitorias2 > vitorias1 ? infoTurno2.turno : 'Empate Técnico')}</strong></div>`;
                desenharGraficoComparativo(labels, dadosGrafico1, dadosGrafico2, infoTurno1.turno, infoTurno2.turno, infoTurno1.tipo);
            } else if (infoTurno1) { // Modos Individuais
                currentChartType = 'individual';
                let modoIndividual = infoTurno1.tipo + 'Individual';
                if (infoTurno1.tipo === 'semanal') html += `<th class="numeric">Meta (%)</th><th class="numeric">Realizado (%)</th><th class="numeric">Dif. (%)</th><th class="numeric">Diferença (Kg)</th><th class="numeric">Diferença (Cx)</th><th class="center">Status Semanal</th></tr></thead><tbody>`;
                else if (infoTurno1.tipo === 'mensal') html += `<th class="numeric">Meta (%)</th><th class="numeric">Realizado Médio (%)</th><th class="numeric">Dif. (%)</th><th class="numeric">Dif. Total (Kg)</th><th class="numeric">Dif. Total (Cx)</th><th class="center">Status Mensal</th></tr></thead><tbody>`;
                else html += `<th class="numeric">Meta (%)</th><th class="numeric">Realizado (%)</th><th class="numeric">Dif. (%)</th><th class="center">Meta Atingida</th><th class="numeric">Quilos (Kg)</th><th class="numeric">Caixas</th></tr></thead><tbody>`;

                for (let item of dadosTurno1) {
                    const { produto, meta: metaStr, realizado: realStr, quilos: kgStr, caixas: cxStr } = item;
                    const m = parseFloat(metaStr) || 0; const r = parseFloat(realStr) || 0;
                    const k = parseFloat(kgStr) || 0; const c = parseFloat(cxStr) || 0;
                    const cA = Math.round(c); const dP = r - m;
                    const cDP = Math.abs(dP) < 1e-4 ? 'na-meta' : (dP > 0 ? 'positivo' : 'negativo');
                    const dPF = `${dP >= 0 ? '+' : ''}${dP.toFixed(3)}%`;
                    html += `<tr><td>${produto}</td><td class="numeric">${m.toFixed(3)}%</td><td class="numeric">${r.toFixed(3)}%</td><td class="numeric ${cDP}">${dPF}</td>`;

                    if (modoIndividual.includes('semanal') || modoIndividual.includes('mensal')) {
                        let dKN = 0; let dCN = 0; let sL = ""; let sC = ""; let dDK = "N/A"; let dDC = "N/A";
                        const lT = modoIndividual.includes('semanal') ? 'Semanal' : 'Mensal'; let dCP = 0;
                        if (m > 0 && r > 0) {
                            const f = m / r; const tK = k * f; const tC = c * f;
                            dKN = k - tK; dCP = c - tC; dCN = Math.round(dCP);
                            dDK = `${dKN >= 0 ? '+' : ''}${dKN.toFixed(2)}`; dDC = `${dCN >= 0 ? '+' : ''}${dCN}`;
                        } else if (m == 0 && r == 0) { dKN = 0; dCN = 0; dDK = "+0.00"; dDC = "+0"; }
                        else if (m > 0 && r == 0) { dKN = -Infinity; dCN = -Infinity; dDK = "(Falta Total)"; dDC = "(Falta Total)"; }
                        else if (m == 0 && r > 0) { dKN = k; dCN = cA; dDK = `+${k.toFixed(2)}`; dDC = `+${cA}`; }
                        if (Math.abs(dKN) < 0.01 && Math.abs(dP) < 1e-4) { sL = `🎯 Na Meta ${lT}`; sC = "na-meta"; dDK = "+0.00"; dDC = "+0"; }
                        else if (dKN > 0 || (m == 0 && r > 0)) { sL = `✅ Excedente ${lT}`; sC = "positivo"; }
                        else { sL = `❌ Faltou ${lT}`; sC = "negativo"; if (dDC !== "(Falta Total)") { dDC = `${dCN >= 0 ? '+' : ''}${dCN}`; } }
                        html += `<td class="numeric ${sC}">${dDK}</td><td class="numeric ${sC}">${dDC}</td><td class="center ${sC}">${sL}</td>`;
                    } else { // Diário
                        const a = Math.abs(r - m) < 1e-4 ? "➖" : (r >= m ? "✅" : "❌");
                        const cM = Math.abs(r - m) < 1e-4 ? "na-meta" : (r >= m ? "positivo" : "negativo");
                        html += `<td class="center ${cM}">${a}</td><td class="numeric">${k.toFixed(2)}</td><td class="numeric">${cA}</td>`;
                    }
                    html += `</tr>`;
                    labels.push(produto); dadosGrafico1.push(m); dadosGrafico2.push(r);
                }
                html += "</tbody></table>";
                desenharGraficoIndividual(labels, dadosGrafico1, dadosGrafico2, infoTurno1.turno, infoTurno1.tipo);
            } else {
                throw new Error("Dados insuficientes ou informações de período ausentes para gerar a tabela.");
            }

        } catch (error) {
            console.error("Erro ao gerar tabela:", error);
            html = `<p class='negativo'>Erro ao gerar a tabela: ${error.message}</p>`;
            pdfButton.style.display = 'none'; // Esconde botão PDF em caso de erro na tabela
        }

        resultadoDiv.innerHTML = html;
        document.getElementById("contentArea").style.display = 'block';
        // Mostra botão PDF apenas se a tabela foi gerada com sucesso (verifica se começa com <table>)
        if (html.startsWith("<table")) {
            pdfButton.style.display = 'inline-block';
        }
    }

    // <<< --- FUNÇÕES PARA MULTI-DIA --- >>>
    function mostrarTabelaMultiDia(dadosDias) {
        destruirGraficos();
        currentChartType = 'multi_dia';
        const resultadoDiv = document.getElementById("resultado");
        const pdfButton = document.querySelector('.btn-pdf-visao');
        let html = "";

        try {
            dadosDias.sort((a, b) => (a.info.dataObj && b.info.dataObj) ? a.info.dataObj - b.info.dataObj : 0);
            const infos = dadosDias.map(d => d.info);
            const todosProdutosSet = new Set();
            dadosDias.forEach(dia => { if (Array.isArray(dia.data)) { dia.data.forEach(item => todosProdutosSet.add(item.produto)); } });
            const todosProdutos = [...todosProdutosSet].sort();

            html = '<table><thead><tr><th>Produto</th>';
            infos.forEach(info => { html += `<th class="numeric">${info.data} (%)</th>`; });
            html += `<th class="numeric">Média (%)</th><th class="numeric">Variação (%)</th><th class="numeric">Total Kg</th><th class="numeric">Total Cx</th></tr></thead><tbody>`;

            const dadosGrafico = []; let totalKgGeral = 0; let totalCxGeral = 0;

            for (const produto of todosProdutos) {
                html += `<tr><td>${produto}</td>`;
                const rendimentosDia = []; let totalKgProduto = 0; let totalCxProduto = 0;
                const produtoDataGrafico = { produto: produto, valores: [] };

                dadosDias.forEach(dia => {
                    const item = Array.isArray(dia.data) ? dia.data.find(it => it.produto === produto) : null;
                    const r = parseFloat(item?.realizado) || 0;
                    const k = parseFloat(item?.quilos) || 0;
                    const c = parseFloat(item?.caixas) || 0;
                    html += `<td class="numeric">${item ? r.toFixed(3) + '%' : '-'}</td>`;
                    produtoDataGrafico.valores.push(item ? r : NaN);
                    if(item) { rendimentosDia.push(r); totalKgProduto += k; totalCxProduto += c; }
                });

                let media = 0; let variacao = 0;
                if (rendimentosDia.length > 0) {
                    media = rendimentosDia.reduce((s, v) => s + v, 0) / rendimentosDia.length;
                    if (rendimentosDia.length > 1) { variacao = Math.max(...rendimentosDia) - Math.min(...rendimentosDia); }
                }
                const tCA = Math.round(totalCxProduto);
                html += `<td class="numeric">${rendimentosDia.length > 0 ? media.toFixed(3) + '%' : '-'}</td>`;
                html += `<td class="numeric">${rendimentosDia.length > 1 ? variacao.toFixed(3) + '%' : (rendimentosDia.length === 1 ? '0.000%' : '-')}</td>`;
                html += `<td class="numeric">${totalKgProduto > 0 ? totalKgProduto.toFixed(2) : '-'}</td>`;
                html += `<td class="numeric">${totalKgProduto > 0 ? tCA : '-'}</td>`;
                html += '</tr>';
                dadosGrafico.push(produtoDataGrafico); totalKgGeral += totalKgProduto; totalCxGeral += tCA;
            }
            html += '</tbody></table>';
            const turno = infos[0].turno; const datasAnalisadas = infos.map(info => info.data).join(', ');
            html += `<div class="summary"><strong>Resumo Comparativo Multi-Dia (${turno}):</strong><br>Dias Analisados: ${datasAnalisadas}<br>Total Geral de Quilos: ${totalKgGeral.toFixed(2)} Kg<br>Total Geral de Caixas: ${totalCxGeral} Cx</div>`;

            desenharGraficoMultiDia(infos, dadosGrafico);

        } catch (error) {
            console.error("Erro ao gerar tabela multi-dia:", error);
            html = `<p class='negativo'>Erro ao gerar a tabela multi-dia: ${error.message}</p>`;
            pdfButton.style.display = 'none';
        }

        resultadoDiv.innerHTML = html;
        document.getElementById("contentArea").style.display = 'block';
        if (html.startsWith("<table")) {
             pdfButton.style.display = 'inline-block';
        }
    }

    function desenharGraficoMultiDia(infos, dadosGrafico) {
        const container = document.getElementById("graficoMultiDiaContainer");
        const canvas = document.getElementById("graficoMultiDia");
        container.style.display = "block";
        document.getElementById("graficoIndividualContainer").style.display = "none";
        document.getElementById("graficoComparativoContainer").style.display = "none";
        const ctx = canvas.getContext('2d');
        if (graficoMultiDiaInstancia) { graficoMultiDiaInstancia.destroy(); }

        const labels = dadosGrafico.map(d => d.produto); const datasets = [];
        const cores = ['rgba(54, 162, 235, 0.7)', 'rgba(255, 99, 132, 0.7)', 'rgba(75, 192, 192, 0.7)', 'rgba(255, 206, 86, 0.7)', 'rgba(153, 102, 255, 0.7)', 'rgba(255, 159, 64, 0.7)'];
        const bordas = ['rgba(54, 162, 235, 1)', 'rgba(255, 99, 132, 1)', 'rgba(75, 192, 192, 1)', 'rgba(255, 206, 86, 1)', 'rgba(153, 102, 255, 1)', 'rgba(255, 159, 64, 1)'];

        infos.forEach((info, index) => {
            datasets.push({ label: `${info.data} (%)`, data: dadosGrafico.map(d => d.valores[index]), backgroundColor: cores[index % cores.length], borderColor: bordas[index % bordas.length], borderWidth: 1, skipNull: true });
        });
        const turno = infos[0].turno; const turnoIcone = turno === 'Turno 1' ? '🌀' : '✳️';
        try {
            graficoMultiDiaInstancia = new Chart(ctx, { type: 'bar', data: { labels: labels, datasets: datasets }, options: commonChartOptions(`Comparativo Multi-Dia ${turnoIcone} ${turno}: Rendimento (% Realizado)`) });
        } catch (error) { console.error("Erro ao criar gráfico Multi-Dia:", error); container.innerHTML = "<p class='negativo'>Erro ao renderizar o gráfico Multi-Dia.</p>"; }
    }
    // <<< --- FIM FUNÇÕES MULTI-DIA --- >>>

    function desenharGraficoComparativo(labels, data1, data2, label1, label2, tipoAnalise) {
        const container = document.getElementById("graficoComparativoContainer");
        const canvas = document.getElementById("graficoComparativo");
        container.style.display = "block";
        document.getElementById("graficoIndividualContainer").style.display = "none";
        document.getElementById("graficoMultiDiaContainer").style.display = "none";
        const ctx = canvas.getContext('2d');
        if (graficoComparativoInstancia) { graficoComparativoInstancia.destroy(); }
        const tipoGraficoComp = tipoAnalise ? tipoAnalise.charAt(0).toUpperCase() + tipoAnalise.slice(1) : 'Comparativo';
        try {
            graficoComparativoInstancia = new Chart(ctx, { type: 'bar', data: { labels: labels, datasets: [{ label: `${label1} (% Realizado)`, backgroundColor: 'rgba(54, 162, 235, 0.7)', borderColor: 'rgba(54, 162, 235, 1)', borderWidth: 1, data: data1, skipNull: true }, { label: `${label2} (% Realizado)`, backgroundColor: 'rgba(75, 192, 192, 0.7)', borderColor: 'rgba(75, 192, 192, 1)', borderWidth: 1, data: data2, skipNull: true }] }, options: commonChartOptions(`Comparativo ${tipoGraficoComp} de Rendimento (% Realizado)`) });
        } catch (error) { console.error("Erro ao criar gráfico comparativo:", error); container.innerHTML = "<p class='negativo'>Erro ao renderizar o gráfico comparativo.</p>"; }
    }

    function desenharGraficoIndividual(labels, metas, realizados, turnoLabel, tipoAnalise) {
        const container = document.getElementById("graficoIndividualContainer");
        const canvas = document.getElementById("graficoIndividual");
        container.style.display = "block";
        document.getElementById("graficoComparativoContainer").style.display = "none";
        document.getElementById("graficoMultiDiaContainer").style.display = "none";
        const ctx = canvas.getContext('2d');
        if (graficoIndividualInstancia) { graficoIndividualInstancia.destroy(); }
        const cMeta = 'rgba(255, 159, 64, 0.7)'; const cReal = turnoLabel.includes("1") ? 'rgba(54, 162, 235, 0.7)' : 'rgba(75, 192, 192, 0.7)';
        const bReal = turnoLabel.includes("1") ? 'rgba(54, 162, 235, 1)' : 'rgba(75, 192, 192, 1)';
        const tipoGrafico = tipoAnalise ? tipoAnalise.charAt(0).toUpperCase() + tipoAnalise.slice(1) : 'Individual';
        try {
            graficoIndividualInstancia = new Chart(ctx, { type: 'bar', data: { labels: labels, datasets: [{ label: 'Meta (%)', backgroundColor: cMeta, borderColor: 'rgba(255, 159, 64, 1)', borderWidth: 1, data: metas }, { label: 'Realizado (%)', backgroundColor: cReal, borderColor: bReal, borderWidth: 1, data: realizados }] }, options: commonChartOptions(`Rendimento ${tipoGrafico} ${turnoLabel}: Meta vs Realizado (%)`) });
        } catch (error) { console.error("Erro ao criar gráfico individual:", error); container.innerHTML = "<p class='negativo'>Erro ao renderizar o gráfico individual.</p>"; }
    }

    // --- Funções de Navegação e Controle ---
    function voltarMenu() {
        destruirGraficos();
        document.querySelector(".menu").style.display = 'block';
        document.querySelector(".voltar").style.display = 'none';
        document.getElementById("info").style.display = 'none';
        document.getElementById("contentArea").style.display = 'none';
        document.getElementById("resultado").innerHTML = "";
        document.querySelector('.btn-pdf-visao').style.display = 'none';
        document.getElementById('seletorPeriodo').style.display = 'none';
        document.getElementById('status').style.display = 'none';
        tipoAnaliseAtual = null;
    }

    function popularSeletorMultiDia(turno) {
        const container = document.getElementById('seletorMultiDia');
        container.innerHTML = '';
        const messageSpan = document.getElementById('checkboxLimitMessage');
        messageSpan.textContent = `Selecione de ${MIN_MULTI_DAY_SELECTION} a ${MAX_MULTI_DAY_SELECTION} dias.`;
        messageSpan.style.color = 'var(--button-grey)';

        const arquivosTurno = arquivosDisponiveis
            .map(nome => extrairInfo(nome))
            .filter(info => info?.tipo === 'diario' && info.turno?.toLowerCase().includes(turno.replace('turno','Turno ')) && info.dataObj instanceof Date && !isNaN(info.dataObj.getTime()))
            .sort((a, b) => b.dataObj - a.dataObj);

        if (arquivosTurno.length === 0) {
            container.innerHTML = '<p>Nenhum dia disponível encontrado para este turno.</p>';
            validarLimiteCheckbox(); return;
        }
        let checkboxesHTML = '';
        arquivosTurno.forEach((info, index) => {
            checkboxesHTML += `<div><input type="checkbox" id="dia_${turno}_${index}" name="multiDiaCheck" value="${info.nome}" onclick="validarLimiteCheckbox()"><label for="dia_${turno}_${index}">${info.tituloPeriodo}</label></div>`;
        });
        container.innerHTML = checkboxesHTML;
        validarLimiteCheckbox();
    }

    function validarLimiteCheckbox() {
        const checkboxes = document.querySelectorAll('input[name="multiDiaCheck"]:checked');
        const count = checkboxes.length;
        const messageSpan = document.getElementById('checkboxLimitMessage');
        const loadButton = document.getElementById('btnCarregarDados');
        if (!loadButton) return;

        messageSpan.textContent = `Selecionados: ${count} (Requerido: ${MIN_MULTI_DAY_SELECTION} a ${MAX_MULTI_DAY_SELECTION})`;
        if (count >= MIN_MULTI_DAY_SELECTION && count <= MAX_MULTI_DAY_SELECTION) {
            messageSpan.style.color = 'var(--positive)'; loadButton.disabled = false;
        } else {
            loadButton.disabled = true;
            messageSpan.style.color = count > MAX_MULTI_DAY_SELECTION ? 'red' : 'var(--button-grey)';
        }
    }

    // CORREÇÃO: Ordem dos 'if' alterada
    function selecionarPeriodo(tipo) {
        tipoAnaliseAtual = tipo;
        document.querySelector(".menu").style.display = 'none';
        document.getElementById("contentArea").style.display = 'none';
        document.getElementById("info").style.display = 'none';
        document.getElementById('status').style.display = 'none';
        destruirGraficos();

        const seletorPeriodoDiv = document.getElementById('seletorPeriodo');
        const tituloSpan = document.getElementById('tipoAnaliseSelecionada');
        const seletorData = document.getElementById('seletorData');
        const seletorSemana = document.getElementById('seletorSemana');
        const seletorMesAno = document.getElementById('seletorMes');
        const seletorMultiDia = document.getElementById('seletorMultiDiaContainer');
        const loadButton = document.getElementById('btnCarregarDados');

        // Esconde todos e reseta botão
        seletorData.style.display = 'none';
        seletorSemana.style.display = 'none';
        seletorMesAno.style.display = 'none';
        seletorMultiDia.style.display = 'none';
        loadButton.disabled = false; // Habilita por padrão

        let tituloAnalise = "Análise";

        // *** INÍCIO DA CORREÇÃO: Verifica Multi-Dia PRIMEIRO ***
        if (tipo === 'comparar_dias_t1' || tipo === 'comparar_dias_t2') {
            tituloAnalise = `Comparativa Multi-Dia ${tipo.includes('t1') ? 'Turno 1' : 'Turno 2'}`;
            seletorMultiDia.style.display = 'block';
            const turnoSelecionado = tipo.includes('t1') ? 'turno1' : 'turno2';
            popularSeletorMultiDia(turnoSelecionado); // Chama a função que valida o botão internamente
        // *** FIM DA CORREÇÃO ***
        } else if (tipo.includes('diario') || tipo.includes('comparar_dia')) { // Agora verifica diário/comparar dia
            tituloAnalise = 'Diária';
            seletorData.style.display = 'block';
            const inputData = document.getElementById('inputData');
            if (!inputData.value) {
                 try { const today = new Date(); today.setMinutes(today.getMinutes() - today.getTimezoneOffset()); inputData.value = today.toISOString().split('T')[0]; }
                 catch(e) { console.error("Não foi possível definir data padrão.", e); }
            }
        } else if (tipo.includes('semanal') || tipo.includes('comparar_semana')) {
            tituloAnalise = 'Semanal';
            seletorSemana.style.display = 'block';
        } else if (tipo.includes('mensal') || tipo.includes('comparar_mes')) {
            tituloAnalise = 'Mensal';
            seletorMesAno.style.display = 'block';
        } // Não precisa de 'else', outros tipos não são esperados

        tituloSpan.textContent = tituloAnalise;
        seletorPeriodoDiv.style.display = 'block';
        document.querySelector(".voltar").style.display = 'inline-block';
    }

    function cancelarSelecao() {
        document.getElementById('seletorPeriodo').style.display = 'none';
        voltarMenu();
    }

    async function carregarDadosSelecionados() {
        // console.log("carregarDadosSelecionados() chamado. Tipo:", tipoAnaliseAtual);
        const statusDiv = document.getElementById("status"); const infoDiv = document.getElementById("info");
        const contentArea = document.getElementById("contentArea"); const pdfButton = document.querySelector('.btn-pdf-visao');

        statusDiv.innerHTML = "⏳ Carregando dados selecionados..."; statusDiv.style.color = "var(--button-grey)";
        statusDiv.style.display = 'block'; infoDiv.style.display = 'none'; contentArea.style.display = 'none';
        pdfButton.style.display = 'none'; document.getElementById('seletorPeriodo').style.display = 'none';
        destruirGraficos();

        let nomesArquivos = []; let modoTabela = ''; let tipoCabecalho = 'individual'; dados = {};

        try {
            if (tipoAnaliseAtual === 'comparar_dias_t1' || tipoAnaliseAtual === 'comparar_dias_t2') {
                const checkboxes = document.querySelectorAll('input[name="multiDiaCheck"]:checked');
                if (checkboxes.length < MIN_MULTI_DAY_SELECTION || checkboxes.length > MAX_MULTI_DAY_SELECTION) throw new Error(`Seleção inválida. Escolha entre ${MIN_MULTI_DAY_SELECTION} e ${MAX_MULTI_DAY_SELECTION} dias.`);
                checkboxes.forEach(cb => nomesArquivos.push(cb.value));
                modoTabela = 'comparativoMultiDia'; tipoCabecalho = 'comparativo_multi_dia';
            } else if (tipoAnaliseAtual.includes('diario') || tipoAnaliseAtual.includes('comparar_dia')) {
                 const dataInput = document.getElementById('inputData').value; if (!dataInput) throw new Error("Nenhuma data selecionada.");
                 const dateObj = new Date(dataInput + 'T00:00:00Z'); const diaSemanaNome = dateObj.toLocaleDateString('pt-BR', { weekday: 'long', timeZone: 'UTC' }).toLowerCase();
                 const diaNum = String(dateObj.getUTCDate()).padStart(2, '0'); const mesNum = String(dateObj.getUTCMonth() + 1).padStart(2, '0'); const anoCurto = String(dateObj.getUTCFullYear()).substring(2);
                 const base1 = `${diaSemanaNome.replace('-feira', '')}.${diaNum}.${mesNum}.${anoCurto}`; const base2 = `${diaSemanaNome.replace('-', '.')}.${diaNum}.${mesNum}.${anoCurto}`;
                 const findFile = (b, t) => arquivosDisponiveis.includes(`${b}.${t}.json`) ? `${b}.${t}.json` : null;
                 let n1 = null, n2 = null;
                 if (tipoAnaliseAtual === 'diario1' || tipoAnaliseAtual === 'comparar_dia') { n1 = findFile(base1, 'turno1') || findFile(base2, 'turno1'); if(n1) nomesArquivos.push(n1); }
                 if (tipoAnaliseAtual === 'diario2' || tipoAnaliseAtual === 'comparar_dia') { n2 = findFile(base1, 'turno2') || findFile(base2, 'turno2'); if(n2) nomesArquivos.push(n2); }
                 modoTabela = tipoAnaliseAtual.includes('comparar') ? 'comparativo' : 'diarioIndividual'; tipoCabecalho = tipoAnaliseAtual.includes('comparar') ? 'comparativo' : 'individual';
            } else if (tipoAnaliseAtual.includes('semanal') || tipoAnaliseAtual.includes('comparar_semana')) {
                const idSemana = document.getElementById('selectSemana').value; if (!idSemana) throw new Error("Nenhuma semana selecionada.");
                if (tipoAnaliseAtual === 'semanal1' || tipoAnaliseAtual === 'comparar_semana') { const n = `${idSemana}.turno1.json`; if (arquivosDisponiveis.includes(n)) nomesArquivos.push(n); }
                if (tipoAnaliseAtual === 'semanal2' || tipoAnaliseAtual === 'comparar_semana') { const n = `${idSemana}.turno2.json`; if (arquivosDisponiveis.includes(n)) nomesArquivos.push(n); }
                modoTabela = tipoAnaliseAtual.includes('comparar') ? 'comparativo' : 'semanalIndividual'; tipoCabecalho = tipoAnaliseAtual.includes('comparar') ? 'comparativo' : 'individual';
            } else if (tipoAnaliseAtual.includes('mensal') || tipoAnaliseAtual.includes('comparar_mes')) {
                const mesNum = document.getElementById('selectMes').value; const anoCompleto = document.getElementById('selectAnoMes').value; if (!mesNum || !anoCompleto) throw new Error("Mês ou ano não selecionado.");
                const base = `mensal.${String(mesNum).padStart(2,'0')}.${anoCompleto.substring(2)}`;
                if (tipoAnaliseAtual === 'mensal1' || tipoAnaliseAtual === 'comparar_mes') { const n = `${base}.turno1.json`; if (arquivosDisponiveis.includes(n)) nomesArquivos.push(n); }
                if (tipoAnaliseAtual === 'mensal2' || tipoAnaliseAtual === 'comparar_mes') { const n = `${base}.turno2.json`; if (arquivosDisponiveis.includes(n)) nomesArquivos.push(n); }
                modoTabela = tipoAnaliseAtual.includes('comparar') ? 'comparativo' : 'mensalIndividual'; tipoCabecalho = tipoAnaliseAtual.includes('comparar') ? 'comparativo' : 'individual';
            }

            if (nomesArquivos.length === 0) throw new Error("Nenhum arquivo de dados correspondente à seleção foi encontrado ou é válido.");
            // console.log("Iniciando fetch para:", nomesArquivos);

            const promessas = nomesArquivos.map(nomeArquivo => {
                if (!arquivosDisponiveis.includes(nomeArquivo)) return Promise.resolve({ error: true, nome: nomeArquivo, message: `Arquivo não encontrado no manifesto: ${nomeArquivo}` }); // Resolve com erro, não rejeita
                return fetch(`${nomeArquivo}?v=${new Date().getTime()}`)
                    .then(res => { if (!res.ok) throw new Error(`Erro HTTP ${res.status}`); return res.json(); })
                    .then(d => ({ info: extrairInfo(nomeArquivo), data: d }))
                    .catch(err => ({ error: true, nome: nomeArquivo, message: `Falha ao carregar ${nomeArquivo}: ${err.message}` }));
            });

            const resultados = await Promise.all(promessas);
            // console.log("Resultados do fetch:", resultados);
            const dadosCarregados = resultados.filter(r => r && !r.error && r.info && r.data);
            const errosCarregamento = resultados.filter(r => r && r.error);

            if (errosCarregamento.length > 0) {
                const msgErro = errosCarregamento.map(e => e.message).join('; ');
                console.warn("Erros de carregamento:", msgErro);
                if (modoTabela === 'comparativoMultiDia' || dadosCarregados.length === 0) throw new Error(`Falha ao carregar arquivos necessários. Erros: ${msgErro}`);
                statusDiv.innerHTML += `<br>⚠️ Atenção: ${msgErro}`; statusDiv.style.color = "orange"; // Aviso se carregamento parcial
            }
            if (dadosCarregados.length === 0) throw new Error("Nenhum dado válido foi carregado.");

            dadosCarregados.sort((a, b) => (a.info?.dataObj && b.info?.dataObj) ? a.info.dataObj - b.info.dataObj : 0);
            const infos = dadosCarregados.map(d => d.info);
            // console.log("Infos carregadas e ordenadas:", infos);

            mostrarCabecalho(infos, tipoCabecalho);

            if (modoTabela === 'comparativoMultiDia') { mostrarTabelaMultiDia(dadosCarregados); }
            else if (modoTabela === 'comparativo') {
                 if (dadosCarregados.length === 2) { mostrarTabela(dadosCarregados[0].data, infos[0], modoTabela, dadosCarregados[1].data, infos[1]); }
                 else { console.warn("Modo Comparativo, mas apenas 1 arquivo encontrado/carregado. Exibindo como individual."); modoTabela = infos[0].tipo + 'Individual'; tipoCabecalho = 'individual'; mostrarCabecalho(infos[0], tipoCabecalho); mostrarTabela(dadosCarregados[0].data, infos[0], modoTabela); }
            } else { // Modos individuais
                 let modoReal = modoTabela; if (dadosCarregados.length === 1 && !modoReal.endsWith('Individual')) { modoReal = infos[0].tipo + 'Individual'; }
                 mostrarTabela(dadosCarregados[0].data, infos[0], modoReal);
            }
            if (errosCarregamento.length === 0) statusDiv.style.display = 'none'; // Esconde status se tudo OK

        } catch (error) {
            console.error("Erro em carregarDadosSelecionados:", error);
            destruirGraficos(); infoDiv.innerHTML = `❌ Erro: ${error.message}`; infoDiv.style.display = 'block';
            contentArea.style.display = 'none'; pdfButton.style.display = 'none';
            statusDiv.innerHTML = `❌ Erro ao carregar: ${error.message}`; statusDiv.style.color = "red"; statusDiv.style.display = 'block';
        }
    }

    // --- Funções de Inicialização ---
    function popularSeletores() {
        const semanas = new Map(); const mesesAnos = new Map(); const anosSet = new Set();
        arquivosDisponiveis.forEach(nomeArquivo => {
            const info = extrairInfo(nomeArquivo);
            if (!info?.tipo || info.tipo === 'N/A' || !(info.dataObj instanceof Date) || isNaN(info.dataObj.getTime())) return;
            if (info.tipo === 'semanal') { const id = nomeArquivo.replace(/\.turno[12]\.json$/, ''); if (!semanas.has(id)) semanas.set(id, { texto: info.tituloPeriodo, data: info.dataObj }); }
            else if (info.tipo === 'mensal') {
                 anosSet.add(info.ano); if (!mesesAnos.has(info.ano)) mesesAnos.set(info.ano, new Map());
                 if (!mesesAnos.get(info.ano).has(info.mes)) { let nM = `Mês ${info.mes}`; try { nM = new Date(Date.UTC(parseInt(info.ano), parseInt(info.mes) - 1, 1)).toLocaleString('pt-BR', { month: 'long', timeZone: 'UTC' }); nM = nM.charAt(0).toUpperCase() + nM.slice(1); } catch(e){} mesesAnos.get(info.ano).set(info.mes, { nome: nM, data: info.dataObj }); }
            }
        });
        const selSem = document.getElementById('selectSemana'); selSem.innerHTML = '<option value="">Selecione...</option>'; [...semanas.entries()].sort(([,a],[,b]) => b.data - a.data).forEach(([id,i]) => { const o=document.createElement('option'); o.value=id; o.textContent=i.texto; selSem.appendChild(o); });
        const selAno = document.getElementById('selectAnoMes'); selAno.innerHTML = '<option value="">Selecione...</option>'; [...anosSet].sort((a,b) => parseInt(b)-parseInt(a)).forEach(a => { const o=document.createElement('option'); o.value=a; o.textContent=a; selAno.appendChild(o); });
        const selMes = document.getElementById('selectMes');
        selAno.addEventListener('change', () => {
             const aSel = selAno.value; selMes.innerHTML = '<option value="">Selecione...</option>';
             if(aSel && mesesAnos.has(aSel)) { [...mesesAnos.get(aSel).entries()].sort(([,a],[,b])=>a.data-b.data).forEach(([mN,mI])=>{ const o=document.createElement('option'); o.value=mN; o.textContent=mI.nome; selMes.appendChild(o); }); }
             else if(aSel) selMes.innerHTML = '<option value="">Nenhum mês encontrado</option>'; else selMes.innerHTML = '<option value="">Selecione o Ano</option>';
        });
        if (selAno.options.length <= 1) selMes.innerHTML = '<option value="">Nenhum ano encontrado</option>';
    }

    async function iniciar() {
        const statusDiv = document.getElementById("status");
        try {
            statusDiv.textContent = "⏳ Carregando manifesto de arquivos..."; statusDiv.style.color = "var(--button-grey)"; statusDiv.style.display = 'block';
            const response = await fetch(`index.json?v=${new Date().getTime()}`);
            if (!response.ok) throw new Error(`Erro ${response.status} ao carregar index.json`);
            const listaManifesto = await response.json(); arquivosDisponiveis = listaManifesto.arquivos || [];
            if (arquivosDisponiveis.length === 0) throw new Error("Nenhum arquivo no manifesto index.json.");
            popularSeletores(); statusDiv.style.display = "none";
        } catch (error) {
            console.error("Erro crítico ao iniciar:", error); statusDiv.innerHTML = `❌ Erro crítico: ${error.message}.`; statusDiv.style.color = "red"; statusDiv.style.display = 'block';
        }
    }

    // --- Função de Exportação PDF ---
    async function exportarPDF_VisaoAtual() {
        console.log("Iniciando exportação PDF...");
        const elCap = document.getElementById('contentArea'); const infoDiv = document.getElementById('info'); const pdfBtn = document.querySelector('.btn-pdf-visao');
        if (!elCap || !infoDiv || !pdfBtn) { console.error("Elementos PDF não encontrados."); return; }
        const btnDisp = pdfBtn.style.display; const animDur = Chart.defaults.animation.duration;

        pdfBtn.style.display = 'none'; Chart.defaults.animation.duration = 0;
        const charts = [graficoIndividualInstancia, graficoComparativoInstancia, graficoMultiDiaInstancia];
        charts.forEach(c => { if (c) try { c.update('none'); } catch (e) { console.warn("Erro update gráfico PDF:", e); } });

        const titleEl = document.createElement('div'); titleEl.innerHTML = infoDiv.innerHTML; titleEl.className = 'info'; titleEl.style.display = 'block';
        if (!(elCap.firstChild && elCap.firstChild.isEqualNode(titleEl))) { elCap.insertBefore(titleEl, elCap.firstChild); }

        let baseFn = 'relatorio_rendimento'; try { let t = (infoDiv.textContent||'').split('\n')[0]; t = t.replace(/[^a-z0-9\s]/gi,'').replace(/\s+/g,'_').toLowerCase(); if(t) baseFn=t.substring(0,50); } catch(e){} const filename = `${baseFn}.pdf`;
        const opt = { margin: 0.4, filename: filename, image: { type: 'jpeg', quality: 0.98 }, html2canvas: { scale: 2, useCORS: true, logging: false, dpi: 192, onrendered: c=>{ try{ const x=c.getContext('2d'); x.imageSmoothingEnabled=false; x.mozImageSmoothingEnabled=false; x.webkitImageSmoothingEnabled=false; x.msImageSmoothingEnabled=false; } catch(e){} } }, jsPDF: { unit: 'in', format: 'a4', orientation: 'landscape' }, pagebreak: { mode: ['css','avoid-all'], avoid: ['.chart-container','.summary','tr','h1','.info','thead'] } };

        await new Promise(r => setTimeout(r, 300));
        try { console.log(`Gerando PDF: ${filename}`); await html2pdf().from(elCap).set(opt).save(); console.log("PDF gerado."); }
        catch (error) { console.error("Erro ao gerar PDF:", error); alert(`Erro PDF: ${error.message}.`); }
        finally {
            if (elCap.firstChild && elCap.firstChild.isEqualNode(titleEl)) { elCap.removeChild(titleEl); }
            pdfBtn.style.display = btnDisp; Chart.defaults.animation.duration = animDur;
            charts.forEach(c => { if (c) try { c.update(); } catch (e) {} }); console.log("Limpeza pós-PDF.");
        }
    }

    // --- Inicia a aplicação ---
    window.onload = iniciar;

</script>
</body>
</html>