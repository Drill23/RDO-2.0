<!--
  Visualizador de Rendimento – PRO v2.0
  -------------------------------------------------------------
  ▸ NOVO 2025‑04‑17
     • Comparação de múltiplos DIAS de um mesmo turno (até 2 datas)
     • Comparação de múltiplos MESES de um mesmo turno (até 2 meses)
     • Comparação ANO‑a‑ANO de um mesmo mês
     • Suporte a Rendimento Industrial por mês (campo "rendimentoIndustrial" no JSON)
     • Gráfico combinado (Meta x Rend.Industrial) + gráfico de produtos
     • UI redesenhada (font Poppins / layout grid / dark‑light friendly)
  -------------------------------------------------------------
  ⚠️  Estrutura JSON mensal ampliada:
      {
        "meta": 81.600,                // meta industrial fixa, opcional se nao houver meta especifica
        "rendimentoIndustrial": 83.600, // ←‑ NOVO (float, %)
        "itens": [ { ... } ]            // mesma estrutura anterior
      }
  -------------------------------------------------------------
-->
<!DOCTYPE html>
<html lang="pt-BR" data-theme="light">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Visualizador de Rendimento PRO v2</title>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.9.2/html2pdf.bundle.min.js"></script>
<style>
 :root{
  --bg:#f5f7fa;--panel:#ffffff;--accent:#0d6efd;--accent2:#20c997;--accent3:#ffc107;--text:#212529;--muted:#6c757d;
  --positive:#198754;--negative:#dc3545;--border:#dee2e6;--shadow:0 2px 6px rgba(0,0,0,.08);
 }
 [data-theme="dark"]{
  --bg:#212529;--panel:#343a40;--accent:#4dabf7;--accent2:#51cf66;--accent3:#ffd43b;--text:#f8f9fa;--muted:#adb5bd;--border:#495057;--shadow:0 2px 6px rgba(0,0,0,.5);
 }
 html,body{margin:0;padding:0;background:var(--bg);color:var(--text);font-family:'Poppins',Segoe UI,Arial,sans-serif;}
 h1{margin:0;padding:1.2rem 0;text-align:center;background:linear-gradient(90deg,var(--accent),var(--accent2));-webkit-background-clip:text;color:transparent;font-size:2rem;}
 .wrapper{max-width:1400px;margin:20px auto;padding:20px;background:var(--panel);box-shadow:var(--shadow);border-radius:10px;}
 .grid{display:grid;gap:1rem;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));margin-bottom:1.5rem;}
 button{all:unset;cursor:pointer;padding:.75rem 1rem;border-radius:8px;background:var(--accent);color:#fff;text-align:center;font-weight:500;transition:.2s;}
 button:hover{opacity:.9;}
 .secondary{background:var(--accent2);} .tertiary{background:var(--accent3);color:#000;}
 .danger{background:var(--negative);} .outline{background:transparent;color:var(--accent);border:2px solid var(--accent);} .outline:hover{background:var(--accent);color:#fff;}
 .hidden{display:none !important;}
 table{width:100%;border-collapse:collapse;margin:1rem 0;font-size:.9rem;}
 th,td{border:1px solid var(--border);padding:.4rem .6rem;text-align:right;}
 th:first-child,td:first-child{text-align:left;}
 th{background:var(--muted);color:#fff;font-weight:600;}
 .positivo{color:var(--positive);font-weight:600;} .negativo{color:var(--negative);font-weight:600;} .na{color:var(--muted);}
 .charts{display:flex;flex-direction:column;gap:1rem;margin-top:1rem;}
 .chartBox{position:relative;width:100%;height:45vh;background:#fff;border:1px solid var(--border);border-radius:8px;padding:10px;}
 </style>
</head>
<body>
 <h1>📈 Visualizador de Rendimento – PRO</h1>
 <div class="wrapper">
  <!-- MENU PRINCIPAL -->
  <div id="menuPrincipal" class="grid">
   <button onclick="abrirSeletor('diario1')">🔵 Diário T1</button>
   <button class="secondary" onclick="abrirSeletor('diario2')">🟢 Diário T2</button>
   <button class="tertiary" onclick="abrirSeletor('comparar_dia')">🟡 Turno 1 × Turno 2 (Dia)</button>
   <button class="outline" onclick="abrirSeletor('dias_turno1')">🔷 Dias T1</button>
   <button class="outline secondary" onclick="abrirSeletor('dias_turno2')">🟢 Dias T2</button>
   <button onclick="abrirSeletor('mensal1')">📅 Mês T1</button>
   <button class="secondary" onclick="abrirSeletor('mensal2')">📅 Mês T2</button>
   <button class="tertiary" onclick="abrirSeletor('comparar_mes')">📅 Turno 1 × Turno 2 (Mês)</button>
   <button class="outline" onclick="abrirSeletor('meses_turno1')">🔷 Meses T1</button>
   <button class="outline secondary" onclick="abrirSeletor('meses_turno2')">🟢 Meses T2</button>
   <button class="danger" onclick="abrirSeletor('mes_ano')">📆 Ano × Ano</button>
   <button class="outline" onclick="toggleTheme()">🌓 Tema</button>
  </div>

  <!-- SELETORES DINÂMICOS -->
  <div id="seletor" class="hidden">
   <div id="containerDatas" class="grid hidden">
    <input id="data1" type="date">
    <input id="data2" type="date">
   </div>
   <div id="containerMeses" class="grid hidden">
    <select id="ano1"></select><select id="mes1"></select>
    <select id="ano2"></select><select id="mes2"></select>
   </div>
   <div class="grid">
    <button onclick="carregar()">Carregar</button>
    <button class="outline" onclick="voltar()">Cancelar</button>
   </div>
  </div>

  <!-- STATUS / INFO -->
  <p id="status" class="muted">Carregando index.json…</p>
  <div id="info" class="hidden"></div>

  <!-- RESULTADOS -->
  <div id="resultado"></div>
  <div id="graficos" class="charts hidden">
   <div class="chartBox"><canvas id="chartProdutos"></canvas></div>
   <div class="chartBox"><canvas id="chartIndustrial"></canvas></div>
  </div>
  <div class="grid hidden" id="acoesPdf"><button class="danger" onclick="exportarPDF()">📄 Exportar PDF</button></div>
 </div>

<script>
const META_INDUSTRIAL = 81.600;
let arquivos=[], tipoAtual="", turnoSelecionado="";
let chartProd=null, chartInd=null;

// ---------- UTIL -------------
const $$ = s=>document.querySelector(s); const $$$ = s=>[...document.querySelectorAll(s)];
function toggleTheme(){ const html=document.documentElement; html.dataset.theme = html.dataset.theme==="dark"?"light":"dark"; }
function limparGraficos(){ if(chartProd){chartProd.destroy();chartProd=null} if(chartInd){chartInd.destroy();chartInd=null} }
function nomeArquivoDia(dateISO,turno){ const d=new Date(dateISO+"T00:00:00"); const dia=d.toLocaleDateString('pt-BR',{weekday:'long',timeZone:'UTC'}).toLowerCase(); const dd=String(d.getUTCDate()).padStart(2,'0'); const mm=String(d.getUTCMonth()+1).padStart(2,'0'); const aa=String(d.getUTCFullYear()).slice(2); return `${dia}.${dd}.${mm}.${aa}.${turno}.json`.replace('sábado','sabado').replace('terça','terca'); }
function nomeArquivoMensal(mes,ano,turno){ const mm=String(mes).padStart(2,'0'); const aa=String(ano).slice(2); return `mensal.${mm}.${aa}.${turno}.json`; }
function extrairTituloMensal(mes,ano){ const n=new Date(ano,mes-1,1).toLocaleString('pt-BR',{month:'long'}); return n.charAt(0).toUpperCase()+n.slice(1)+"/"+ano; }
function corMeta(){return 'rgba(255,159,64,.7)'}
function corTurno(turno){return turno==='turno1'? 'rgba(54,162,235,.7)':'rgba(75,192,192,.7)'}

// ---------- MENU / SELEÇÃO ------------
function abrirSeletor(tipo){tipoAtual=tipo; turnoSelecionado = tipo.includes('2')? 'turno2':'turno1';
 $('#menuPrincipal').classList.add('hidden'); $('#seletor').classList.remove('hidden');
 // reset
 $$$('#seletor .grid').forEach(el=>el.classList.add('hidden'));
 if(tipo.startsWith('dia')){ $('#containerDatas').classList.remove('hidden'); }
 else if(tipo.startsWith('mes')){ $('#containerMeses').classList.remove('hidden'); preencherMesAno(); }
 else if(tipo==='comparar_dia'){ $('#containerDatas').classList.remove('hidden'); }
 else if(tipo==='comparar_mes'){ $('#containerMeses').classList.remove('hidden'); preencherMesAno(); }
 else if(tipo==='mes_ano'){ $('#containerMeses').classList.remove('hidden'); preencherMesAno(true); }
 }
function voltar(){ $('#seletor').classList.add('hidden'); $('#menuPrincipal').classList.remove('hidden'); $('#status').textContent=''; limparGraficos(); $('#resultado').innerHTML=''; $('#info').classList.add('hidden'); $('#graficos').classList.add('hidden'); $('#acoesPdf').classList.add('hidden'); }
function preencherMesAno(duploAno=false){ const anos=[...new Set(arquivos.filter(a=>a.startsWith('mensal')).map(a=>2000+parseInt(a.split('.')[2])) )].sort((a,b)=>b-a);
 const anosSel=[$('#ano1'),$('#ano2')]; anosSel.forEach(sel=>{sel.innerHTML='<option value>Ano</option>'+anos.map(y=>`<option>${y}</option>`).join(''); sel.disabled=false;});
 if(!duploAno) $('#ano2').disabled=true;
 ['mes1','mes2'].forEach(id=>$('#'+id).innerHTML='<option value>Mês</option>'+[...Array(12).keys()].map(i=>`<option value="${i+1}">${i+1}</option>`).join(''));
 }
$('#ano1').addEventListener('change',()=> $('#ano2').disabled = !$('#ano2').disabled && tipoAtual==='mes_ano');

// ---------- CARREGAR -------------
async function carregar(){ try{
  $('#status').textContent='⏳ Carregando…';
  let files=[]; let label1="",label2="";
  if(tipoAtual==='diario1'||tipoAtual==='diario2'){
    const dt=$('#data1').value; if(!dt)throw'Escolha a data';
    files.push({f:nomeArquivoDia(dt,turnoSelecionado), tag:'Dia'});
    label1=new Date(dt).toLocaleDateString('pt-BR');
  }else if(tipoAtual==='comparar_dia'){
    const d1=$('#data1').value, d2=$('#data2').value; if(!d1||!d2)throw'Datas faltando';
    files=[{f:nomeArquivoDia(d1,'turno1') ,turno:'T1',label:new Date(d1).toLocaleDateString('pt-BR')},{f:nomeArquivoDia(d2,'turno2'),turno:'T2',label:new Date(d2).toLocaleDateString('pt-BR')}];
  }else if(tipoAtual==='dias_turno1'||tipoAtual==='dias_turno2'){
    const d1=$('#data1').value, d2=$('#data2').value; if(!d1||!d2)throw'Datas faltando';
    files=[{f:nomeArquivoDia(d1,turnoSelecionado),label:new Date(d1).toLocaleDateString('pt-BR')},{f:nomeArquivoDia(d2,turnoSelecionado),label:new Date(d2).toLocaleDateString('pt-BR')}];
  }else if(tipoAtual==='mensal1'||tipoAtual==='mensal2'){
    const m=$('#mes1').value, a=$('#ano1').value; if(!m||!a)throw'Selecione mês e ano';
    files.push({f:nomeArquivoMensal(m,a,turnoSelecionado),label:extrairTituloMensal(m,a)});
  }else if(tipoAtual==='comparar_mes'){
    const m=$('#mes1').value, a=$('#ano1').value; if(!m||!a)throw'Selecione mês/ano';
    files=[{f:nomeArquivoMensal(m,a,'turno1'),label:'T1'},{f:nomeArquivoMensal(m,a,'turno2'),label:'T2'}];
  }else if(tipoAtual==='meses_turno1'||tipoAtual==='meses_turno2'){
    const m1=$('#mes1').value,a1=$('#ano1').value,m2=$('#mes2').value,a2=$('#ano2').value; if(!m1||!a1||!m2||!a2)throw'Selecione os dois meses';
    files=[{f:nomeArquivoMensal(m1,a1,turnoSelecionado),label:extrairTituloMensal(m1,a1)},{f:nomeArquivoMensal(m2,a2,turnoSelecionado),label:extrairTituloMensal(m2,a2)}];
  }else if(tipoAtual==='mes_ano'){
    const m=$('#mes1').value,a1=$('#ano1').value,a2=$('#ano2').value; if(!m||!a1||!a2)throw'Selecione mês e anos';
    files=[{f:nomeArquivoMensal(m,a1,'turno1'),label:extrairTituloMensal(m,a1)},{f:nomeArquivoMensal(m,a2,'turno1'),label:extrairTituloMensal(m,a2)}];
  }
  // verifica existência
  files.forEach(o=>{if(!arquivos.includes(o.f))throw`Arquivo não encontrado: ${o.f}`});
  // carrega
  const dados=await Promise.all(files.map(o=>fetch(o.f).then(r=>r.json())));
  // render
  renderizar(files,dados);
  $('#seletor').classList.add('hidden');
 }catch(e){ alert(e); $('#status').textContent=''; }
}

// ---------- RENDERIZAÇÃO -------------
function renderizar(files,dados){ limparGraficos();
 // tabela produtos comparativa
 let labels=[],meta=[],val1=[],val2=[];
 let html='<table><thead><tr><th>Produto</th>';
 if(dados.length===1){ html+='<th>Meta %</th><th>Realizado %</th><th>Dif %</th><th>Kg</th><th>Cx</th></tr></thead><tbody>'; }
 else{ html+=`<th>${files[0].label} %</th><th>${files[1].label} %</th><th>Dif %</th><th>Dif Kg</th><th>Dif Cx</th></tr></thead><tbody>`; }
 // Assumir estrutura dados[i].itens
 const it1=dados[0].itens; const it2=dados[1]?dados[1].itens:[];
 const produtos=[...new Set([...it1.map(i=>i.produto),...it2.map(i=>i.produto)])];
 produtos.forEach(p=>{
  const d1=it1.find(i=>i.produto===p)||{}; const d2=it2.find(i=>i.produto===p)||{};
  const m=d1.meta||d2.meta||0; const r1=parseFloat(d1.realizado)||0; const r2=parseFloat(d2.realizado)||0; const diff=r2-r1;
  const kg1=+d1.quilos||0,kg2=+d2.quilos||0,cx1=Math.round(+d1.caixas||0),cx2=Math.round(+d2.caixas||0);
  const diffKg=kg2-kg1,diffCx=cx2-cx1;
  labels.push(p); meta.push(m); val1.push(r1); if(dados.length>1) val2.push(r2);
  html+=`<tr><td>${p}</td>`;
  if(dados.length===1){ const diffPerc=r1-m; const cls=diffPerc>0?'positivo':diffPerc<0?'negativo':'na'; html+=`<td>${m.toFixed(3)}%</td><td>${r1.toFixed(3)}%</td><td class="${cls}">${diffPerc.toFixed(3)}%</td><td>${kg1.toFixed(2)}</td><td>${cx1}</td>`; }
  else{ const cls=diff>0?'positivo':diff<0?'negativo':'na'; html+=`<td>${r1.toFixed(3)}%</td><td>${r2.toFixed(3)}%</td><td class="${cls}">${diff.toFixed(3)}%</td><td class="${cls}">${diffKg.toFixed(2)}</td><td class="${cls}">${diffCx}</td>`; }
  html+='</tr>';
 });
 html+='</tbody></table>'; $('#resultado').innerHTML=html;
 // info
 $('#info').classList.remove('hidden'); $('#info').innerHTML=`<h3>🔍 ${files.map(f=>f.label).join(' x ')}</h3>`;
 // gráfico produtos
 const ctx1=$('#chartProdutos').getContext('2d');
 const datasets=[{label:'Meta %',data:meta,backgroundColor:corMeta()} ,{label:files[0].label,data:val1,backgroundColor:corTurno(files[0].f.includes('turno1')?'turno1':'turno2')}];
 if(dados.length>1) datasets.push({label:files[1].label,data:val2,backgroundColor:corTurno(files[1].f.includes('turno1')?'turno1':'turno2')});
 chartProd=new Chart(ctx1,{type:'bar',data:{labels,datasets},options:{responsive:true,plugins:{legend:{position:'top'},title:{display:true,text:'Meta × Realizado (%)'}}}});
 // gráfico industrial se for mensal
 if(files[0].f.startsWith('mensal')){ const ind1=dados[0].rendimentoIndustrial||0,ind2=dados[1]?dados[1].rendimentoIndustrial:undefined;
  const ctx2=$('#chartIndustrial').getContext('2d'); const dataInd={labels:['Meta',files[0].label].concat(ind2!==undefined?[files[1].label]:[]),datasets:[{type:'bar',label:'Rendimento Industrial %',backgroundColor:['#ffa94d','#74c0fc','#8ce99a'],data:[META_INDUSTRIAL,ind1].concat(ind2!==undefined?[ind2]:[])},{type:'line',label:'Meta',borderColor:'#ff922b',data:[META_INDUSTRIAL,META_INDUSTRIAL,META_INDUSTRIAL].slice(0,ind2!==undefined?3:2),fill:false}]}; chartInd=new Chart(ctx2,{data:dataInd}); }
 $('#graficos').classList.remove('hidden'); $('#acoesPdf').classList.remove('hidden'); $('#status').textContent=''; }

// ---------- PDF -------------
async function exportarPDF(){ const el=$('.wrapper'); const opt={margin:.3,filename:'relatorio.pdf',image:{type:'jpeg',quality:.95},html2canvas:{scale:2},jsPDF:{unit:'in',format:'a4',orientation:'landscape'}}; await html2pdf().from(el).set(opt).save(); }

// ---------- INICIALIZAÇÃO -------------
async function init(){ const r=await fetch('index.json'); const j=await r.json(); arquivos=j.arquivos||[]; $('#status').textContent=''; }
window.addEventListener('DOMContentLoaded',init);
</script>
</body>
</html>
