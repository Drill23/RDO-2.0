<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Visualizador de Rendimento Profissional</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.9.2/html2pdf.bundle.min.js"></script>
  <style>
    :root {
      --bg-primary: #fafafa;
      --bg-secondary: #ffffff;
      --accent: #007aff;
      --accent-alt: #34c759;
      --text: #1c1c1e;
      --radius: 8px;
      --shadow: rgba(0,0,0,0.1) 0px 2px 8px;
    }
    * { box-sizing: border-box; }
    body { margin:0; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto; background: var(--bg-primary); color: var(--text); }
    .container { max-width: 1200px; margin: 24px auto; background: var(--bg-secondary); border-radius: var(--radius); box-shadow: var(--shadow); overflow: hidden; }
    header { background: var(--accent); color: #fff; padding: 16px; font-size: 1.4rem; font-weight: 600; }
    nav { display: flex; flex-wrap: wrap; padding: 12px; gap: 8px; background: var(--bg-secondary); }
    nav button { flex:1; padding: 10px; border:none; border-radius: var(--radius); background: var(--accent); color:#fff; cursor:pointer; transition: background 0.2s; }
    nav button:hover { background: #0051a8; }
    #controls { padding: 24px; display: grid; gap:16px; grid-template-columns: repeat(auto-fit,minmax(200px,1fr)); border-bottom:1px solid #ddd; }
    #controls label { display:block; margin-bottom:4px; font-size:0.9em; }
    #controls input, #controls select { width:100%; padding:8px; border:1px solid #ccc; border-radius:4px; }
    .button-group { display:flex; gap:8px; }
    .button-group button { flex:1; background: var(--accent-alt); }
    .button-group button:hover { background:#28a745; }
    .content { padding:24px; }
    .charts { display:grid; grid-template-columns:1fr; gap:32px; }
    .chart-card { background: var(--bg-secondary); border-radius: var(--radius); box-shadow: var(--shadow); padding:16px; }
    canvas { width:100% !important; height:auto !important; }
    table { width:100%; border-collapse: collapse; margin-top:16px; }
    th, td { border:1px solid #ddd; padding:8px; text-align:left; }
    th { background:#f0f0f0; }
    .positivo { color: green; } .negativo { color: red; }
    footer { text-align:right; padding:12px 24px; background: var(--bg-secondary); border-top:1px solid #ddd; }
    footer button { background: #ff3b30; color:#fff; padding:10px 16px; border:none; border-radius:4px; cursor:pointer; }
    footer button:hover { background:#c02b22; }
  </style>
</head>
<body>
  <div class="container">
    <header>ðŸ“Š Visualizador de Rendimento Profissional</header>
    <nav>
      <button onclick="setView('diario')">DiÃ¡rio</button>
      <button onclick="setView('dias-multiplos')">Comparar Dias</button>
      <button onclick="setView('mensal')">Mensal</button>
      <button onclick="setView('meses-multiplos')">Comparar Meses</button>
      <button onclick="setView('mes-ano')">MÃªs/Ano</button>
    </nav>
    <div id="controls"></div>
    <div class="content">
      <div class="charts" id="charts"></div>
    </div>
    <footer><button onclick="exportarPDF()">Exportar em PDF</button></footer>
  </div>
  <script>
    let arquivos = [], view=null, turno=1;
    window.onload = async ()=>{ try{ const res=await fetch('index.json'); const j=await res.json(); arquivos=j.arquivos||[]; }catch{} setView('diario'); };
    function setView(v){ view=v; document.getElementById('charts').innerHTML=''; const c=document.getElementById('controls'); c.innerHTML='';
      // Turno selector common
      if(['dias-multiplos','meses-multiplos','diario','mensal','mes-ano'].includes(v)){
        const bg=document.createElement('div'); bg.className='button-group';
        ['1','2'].forEach(t=>{ const b=document.createElement('button'); b.textContent='Turno '+t; b.onclick=()=>{ turno=parseInt(t); repopular(); }; bg.appendChild(b); });
        c.appendChild(bg);
      }
      if(v==='diario'){
        const inp=document.createElement('input'); inp.type='date'; inp.id='dt1'; inp.value=new Date().toISOString().slice(0,10);
        c.appendChild(label('Data:')); c.appendChild(inp);
        c.appendChild(button('Analisar', gerarDiario));
      }
      else if(v==='dias-multiplos'){
        c.appendChild(label('Escolha Dias:')); const sel=document.createElement('select'); sel.id='selDias'; sel.multiple=true; sel.size=5;
        popularSelect('diario', sel);
        c.appendChild(sel); c.appendChild(button('Comparar', gerarDiasMultiplos));
      }
      else if(v==='mensal'){
        c.appendChild(label('Ano:')); const pak=selectAnos(); pak.id='ano1'; c.appendChild(pak);
        c.appendChild(label('MÃªs:')); const sep=selectMeses(); sep.id='mes1'; c.appendChild(sep);
        c.appendChild(label('Meta Industrial (%):')); const mi=document.createElement('input'); mi.type='number'; mi.step='0.001'; mi.id='metaInd'; mi.value='81.600'; c.appendChild(mi);
        c.appendChild(label('Rendimento Industrial (%):')); const ri=document.createElement('input'); ri.type='number'; ri.step='0.001'; ri.id='realInd'; ri.value='81.200'; c.appendChild(ri);
        c.appendChild(button('Analisar', gerarMensal));
      }
      else if(v==='meses-multiplos'){
        c.appendChild(label('Ano:')); const pa=selectAnos(); pa.id='ano2'; c.appendChild(pa);
        c.appendChild(label('MÃªs(es):')); const sm=document.createElement('select'); sm.id='selMeses'; sm.multiple=true; sm.size=5; c.appendChild(sm);
        pa.onchange=()=>{ preenchMesesMult(sm, pa.value); };
        c.appendChild(button('Comparar', gerarMesesMultiplos));
      }
      else if(v==='mes-ano'){
        c.appendChild(label('Ano Base:')); const ab=selectAnos(); ab.id='anoB'; c.appendChild(ab);
        c.appendChild(label('Ano Comparativo:')); const ac=selectAnos(); ac.id='anoC'; c.appendChild(ac);
        c.appendChild(label('MÃªs:')); const ma=selectMeses(); ma.id='mesA'; c.appendChild(ma);
        c.appendChild(button('Comparar', gerarMesAno));
      }
      function repopular(){ setView(view); }
    }
    function label(txt){ const l=document.createElement('label'); l.textContent=txt; return l; }
    function button(txt,fn){ const b=document.createElement('button'); b.textContent=txt; b.onclick=fn; return b; }
    function selectAnos(){ const s=document.createElement('select'); const anos=new Set(); arquivos.forEach(f=>{ const p=f.split('.'); if(p[0]==='mensal') anos.add('20'+p[2]); }); [...anos].sort().forEach(a=>s.innerHTML+=`<option>${a}</option>`); return s; }
    function selectMeses(){ const s=document.createElement('select'); for(let i=1;i<=12;i++){ const m=('0'+i).slice(-2); const n=new Date(2025,i-1,1).toLocaleString('pt-BR',{month:'long'}); s.innerHTML+=`<option value='${m}'>${n}</option>`; } return s; }
    function popularSelect(tipo, sel){ sel.innerHTML=''; arquivos.forEach(f=>{ const p=f.split('.'); if(p[0]==='segunda'||p[0]==='terca'||p[0]==='quarta'||p[0]==='quinta'||p[0]==='sexta'||p[0]==='sabado'||p[0]==='domingo'){ if(f.includes(`turno${turno}`)){ const info=extrairInfo(f); const opt=new Option(info.tituloPeriodo,f); sel.add(opt);} } }); }
    function preenchMesesMult(sel, ano){ sel.innerHTML=''; arquivos.forEach(f=>{ const p=f.split('.'); if(p[0]==='mensal'&&('20'+p[2])===ano){ const nome=new Date(20+p[2],p[1]-1,1).toLocaleString('pt-BR',{month:'long'}); sel.add(new Option(nome+`/${ano}`,`${p[1]}.${p[2]}`)); } }); }
    function extrairInfo(f){ const p=f.replace('.json','').split('.'); if(p[0]==='semana'){} else if(p[0]==='mensal'){ const ano='20'+p[2]; const mes=p[1]; const nome=new Date(ano,mes-1,1).toLocaleString('pt-BR',{month:'long'}); return { tituloPeriodo:`${nome}/${ano}` }; } else{ const dia=p[0]; const diaNum=p[1]; const mes=p[2]; const ano='20'+p[3]; const cap=dia.charAt(0).toUpperCase()+dia.slice(1); return { tituloPeriodo:`${cap}, ${('0'+diaNum).slice(-2)}/${mes}/${ano}` }; } return{}; }
    async function fetchJSON(nome){ try{ const r=await fetch(nome); if(!r.ok) throw ''; return await r.json(); }catch(e){ alert('Erro ao carregar '+nome); return null;} }
    async function gerarDiario(){ const dt=document.getElementById('dt1').value; if(!dt) return; const [y,m,d]=dt.split('-'); const short= d+'.'+m+'.'+y.slice(2); const f=`${getSemanaFeira(dt, short)}turno${turno}.json`; const data=await fetchJSON(f); if(!data) return; renderIndividual(data, `DiÃ¡rio ${dt}`); }
    async function gerarDiasMultiplos(){ const sel=document.getElementById('selDias'); const opts=[...sel.selectedOptions].map(o=>o.value); if(opts.length<2) return alert('Selecione ao menos 2 dias'); const files=opts; const datas=await Promise.all(files.map(f=>fetchJSON(f))); renderComparativo(files.map(f=>extrairInfo(f).tituloPeriodo), datas); }
    async function gerarMensal(){ const ano=document.getElementById('ano1').value.slice(2); const mes=document.getElementById('mes1').value; const f=`mensal.${mes}.${ano}.turno${turno}.json`; const data=await fetchJSON(f); const meta= parseFloat(document.getElementById('metaInd').value); const real= parseFloat(document.getElementById('realInd').value); renderIndividual(data, `Mensal ${mes}/${'20'+ano}`, meta, real); }
    async function gerarMesesMultiplos(){ const sel=document.getElementById('selMeses'); const vals=[...sel.selectedOptions].map(o=>o.value); if(vals.length<2) return; const [m1,a1]=vals[0].split('.'); const [m2,a2]=vals[1].split('.'); const f1=`mensal.${m1}.${a1}.turno${turno}.json`; const f2=`mensal.${m2}.${a2}.turno${turno}.json`; const d1=await fetchJSON(f1), d2=await fetchJSON(f2); renderComparativo([`${extrairInfo(f1).tituloPeriodo}`,`${extrairInfo(f2).tituloPeriodo}`],[d1,d2]); }
    async function gerarMesAno(){ const anoB=document.getElementById('anoB').value.slice(2); const anoC=document.getElementById('anoC').value.slice(2); const mes=document.getElementById('mesA').value; const f1=`mensal.${mes}.${anoB}.turno${turno}.json`; const f2=`mensal.${mes}.${anoC}.turno${turno}.json`; const d1=await fetchJSON(f1), d2=await fetchJSON(f2); renderComparativo([`${extrairInfo(f1).tituloPeriodo}`,`${extrairInfo(f2).tituloPeriodo}`],[d1,d2]); }
    function renderIndividual(data,title,meta,real){ const chs=document.getElementById('charts'); chs.innerHTML=''; const card=document.createElement('div'); card.className='chart-card'; const canvas=document.createElement('canvas'); card.appendChild(canvas); if(meta!=null&&real!=null){ const card2=document.createElement('div'); card2.className='chart-card'; const cvs2=document.createElement('canvas'); card2.appendChild(cvs2); chs.appendChild(card2); new Chart(cvs2.getContext('2d'),{type:'bar',data:{labels:['Meta','Realizado'],datasets:[{label:'Rendimento Industrial',data:[meta,real]}]},options:{responsive:true,plugins:{title:{display:true,text:'Rendimento Industrial (%)'}}}});
      // summary
      const sm=document.createElement('table'); sm.innerHTML=`<thead><tr><th>Meta</th><th>Realizado</th><th>Dif (%)</th></tr></thead><tbody><tr><td>${meta.toFixed(3)}%</td><td>${real.toFixed(3)}%</td><td class="${real-meta>0?'positivo':'negativo'}">${(real-meta>=0?'+':'')+(real-meta).toFixed(3)}%</td></tr></tbody>`;
      chs.appendChild(sm);
    }
    new Chart(canvas.getContext('2d'),{type:'bar',data:{labels:data.map(i=>i.produto),datasets:[{label:'Realizado (%)',data:data.map(i=>parseFloat(i.realizado))}]},options:{responsive:true,plugins:{title:{display:true,text:title}}}});
      chs.appendChild(card);
    }
    function renderComparativo(labels, datasets){ const chs=document.getElementById('charts'); chs.innerHTML=''; const card=document.createElement('div'); card.className='chart-card'; const canvas=document.createElement('canvas'); card.appendChild(canvas); chs.appendChild(card);
      const dataKeys=Array.isArray(datasets[0])?datasets:datasets;
      new Chart(canvas.getContext('2d'),{type:'bar',data:{labels:labels, datasets: dataKeys.map((d,i)=>({label:labels[i], data:d.map(i=>parseFloat(i.realizado))}))},options:{responsive:true,plugins:{title:{display:true,text:'Comparativo'}}}});
      // Table for diff between first two
      const d1=datasets[0], d2=datasets[1], prods=new Set([...d1.map(i=>i.produto),...d2.map(i=>i.produto)]);
      const tbl=document.createElement('table'); let html='<thead><tr><th>Produto</th><th>'+labels[0]+'</th><th>'+labels[1]+'</th><th>Dif (%)</th><th>Dif (Kg)</th><th>Dif (Cx)</th></tr></thead><tbody>';
      prods.forEach(prod=>{ const e1=d1.find(i=>i.produto===prod)||{}, e2=d2.find(i=>i.produto===prod)||{}; const r1=parseFloat(e1.realizado)||0, r2=parseFloat(e2.realizado)||0; const q1=parseFloat(e1.quilos)||0, q2=parseFloat(e2.quilos)||0; const c1=parseFloat(e1.caixas)||0, c2=parseFloat(e2.caixas)||0; const dp=r2-r1, dq=q2-q1, dc=Math.round(c2)-Math.round(c1); html+=`<tr><td>${prod}</td><td>${r1.toFixed(3)}%</td><td>${r2.toFixed(3)}%</td><td class="${dp>0?'positivo':'negativo'}">${(dp>=0?'+':'')+dp.toFixed(3)}%</td><td class="${dq>0?'positivo':'negativo'}">${(dq>=0?'+':'')+dq.toFixed(2)}</td><td class="${dc>0?'positivo':'negativo'}">${(dc>=0?'+':'')+dc}</td></tr>`; });
      tbl.innerHTML=html+'</tbody>';
      chs.appendChild(tbl);
    }
    function getSemanaFeira(dt,short){ const wk=new Date(dt+'T00:00:00'); const day=wk.toLocaleDateString('pt-BR',{weekday:'long'}).toLowerCase(); const sem=day.includes('feira')?day.replace('-feira','')+'.feira.'+short+'.': day+'.'+short+'.'; return sem; }
    function exportarPDF(){ html2pdf().from(document.querySelector('.content')).set({margin:0.4, filename:'relatorio.pdf', jsPDF:{orientation:'landscape'}}).save(); }
  </script>
</body>
</html>