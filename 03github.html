<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Visualizador de Rendimento Profissional</title>
  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <!-- html2pdf -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.9.2/html2pdf.bundle.min.js"></script>
  <!-- CSS Geral -->
  <style>
    :root {
      --bg-primary: #fafafa;
      --bg-secondary: #ffffff;
      --accent-color: #007aff;
      --accent-hover: #0051a8;
      --accent-alt: #34c759;
      --text-color: #1c1c1e;
      --border-radius: 8px;
      --shadow: rgba(0,0,0,0.1) 0px 2px 8px;
    }
    body {
      margin: 0; padding: 0;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Oxygen;
      background: var(--bg-primary);
      color: var(--text-color);
    }
    .container {
      max-width: 1200px;
      margin: 24px auto;
      background: var(--bg-secondary);
      border-radius: var(--border-radius);
      box-shadow: var(--shadow);
      overflow: hidden;
    }
    header {
      background: var(--accent-color);
      color: #fff;
      padding: 16px 24px;
      font-size: 1.5rem;
      font-weight: 600;
    }
    nav {
      display: flex;
      flex-wrap: wrap;
      padding: 12px 24px;
      gap: 8px;
      background: var(--bg-secondary);
    }
    nav button {
      flex: 1;
      padding: 10px 14px;
      border: none;
      border-radius: var(--border-radius);
      background: var(--accent-color);
      color: #fff;
      cursor: pointer;
      transition: background 0.2s ease;
    }
    nav button:hover { background: var(--accent-hover); }

    #controls {
      padding: 24px;
      border-bottom: 1px solid #ddd;
      display: grid;
      gap: 16px;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    }
    #controls label { display: block; margin-bottom: 4px; font-size: 0.9em; }
    #controls input, #controls select {
      width: 100%; padding: 8px;
      border: 1px solid #ccc; border-radius: 4px;
    }
    #controls .button-group {
      display: flex; gap: 8px; flex-wrap: wrap;
    }
    #controls .button-group button {
      flex: 1;
      background: var(--accent-alt);
    }
    #controls .button-group button:hover { background: #28a745; }

    .content {
      padding: 24px;
    }
    .charts {
      display: grid;
      grid-template-columns: 1fr;
      gap: 32px;
    }
    .chart-card {
      background: var(--bg-secondary);
      border-radius: var(--border-radius);
      box-shadow: var(--shadow);
      padding: 16px;
    }
    canvas { width: 100% !important; height: auto !important; }

    footer {
      text-align: right;
      padding: 12px 24px;
      background: var(--bg-secondary);
      border-top: 1px solid #ddd;
    }
    footer button {
      background: #ff3b30;
    }
    footer button:hover { background: #c02b22; }
  </style>
</head>
<body>
  <div class="container">
    <header>üìä Visualizador de Rendimento Profissional</header>
    <nav>
      <button onclick="setView('diario')">Di√°rio</button>
      <button onclick="setView('diario-multi')">Comparar Dias</button>
      <button onclick="setView('mensal')">Mensal</button>
      <button onclick="setView('mensal-multi')">Comparar Meses</button>
      <button onclick="setView('anual')">Ano a Ano</button>
    </nav>
    <div id="controls">
      <!-- Dinamicamente preenchido -->
    </div>
    <div class="content">
      <div class="charts" id="charts">
        <!-- Cards de gr√°ficos gerados -->
      </div>
    </div>
    <footer>
      <button onclick="exportarPDF()">Exportar em PDF</button>
    </footer>
  </div>

  <script>
    const arquivos = []; // ser√° preenchido pelo manifesto
    let view = null;

    async function iniciar() {
      // Carrega index.json
      try {
        const res = await fetch('index.json');
        const { arquivos: list } = await res.json();
        arquivos.push(...list);
      } catch(e) {
        console.error('Erro ao ler manifesto:', e);
      }
      // Come√ßa em di√°rio
      setView('diario');
    }

    function setView(tipo) {
      view = tipo;
      const ctrl = document.getElementById('controls');
      ctrl.innerHTML = '';
      document.getElementById('charts').innerHTML = '';

      if (tipo === 'diario') {
        ctrl.innerHTML = `
          <label>Selecione o Turno:</label>
          <div class="button-group">
            <button onclick="selecionarDiario(1)">Turno 1</button>
            <button onclick="selecionarDiario(2)">Turno 2</button>
          </div>
          <label>Data:</label>
          <input type="date" id="inputData" value="${new Date().toISOString().slice(0,10)}">
          <button onclick="gerarDiarioMulti(false)">Analisar</button>
        `;

      } else if (tipo === 'diario-multi') {
        ctrl.innerHTML = `
          <label>Selecione o Turno:</label>
          <div class="button-group">
            <button onclick="setTurnoSelecionado(1)">Turno 1</button>
            <button onclick="setTurnoSelecionado(2)">Turno 2</button>
          </div>
          <label>Datas (M√∫ltiplas):</label>
          <input type="date" id="dataMulti" multiple>
          <button onclick="gerarDiarioMulti(true)">Comparar Dias</button>
        `;

      } else if (tipo === 'mensal' || tipo === 'mensal-multi') {
        const multi = tipo === 'mensal-multi';
        ctrl.innerHTML = `
          <label>Selecione o Turno:</label>
          <div class="button-group">
            <button onclick="setTurnoSelecionado(1)">Turno 1</button>
            <button onclick="setTurnoSelecionado(2)">Turno 2</button>
          </div>
          <label>Ano:</label>
          <select id="selectAno"></select>
          <label>M√™s${multi ? 's (Ctrl+clique)' : ''}:</label>
          <select id="selectMes" ${multi?'multiple':''}></select>
          <button onclick="gerarMensalMulti(${multi})">${multi?'Comparar Meses':'Analisar M√™s'}</button>
        `;
        popularAnosMeses();

      } else if (tipo === 'anual') {
        ctrl.innerHTML = `
          <label>Turno:</label>
          <div class="button-group">
            <button onclick="setTurnoSelecionado(1)">Turno 1</button>
            <button onclick="setTurnoSelecionado(2)">Turno 2</button>
          </div>
          <label>Ano Base:</label>
          <select id="anoBase"></select>
          <label>Ano Comparativo:</label>
          <select id="anoComp"></select>
          <button onclick="gerarAnoAno()">Comparar Anos</button>
        `;
        popularAnos();
      }
    }

    let turnoSelecionado = 1;
    function setTurnoSelecionado(t) { turnoSelecionado = t; }

    // -------- Fun√ß√µes de popular seletores --------
    function popularAnosMeses() {
      const anos = new Set();
      arquivos.forEach(nome => {
        const p = nome.split('.');
        if(p[0]==='mensal') anos.add('20'+p[2]);
      });
      const selAno = document.getElementById('selectAno');
      selAno.innerHTML = '<option>Selecione...</option>';
      [...anos].sort().forEach(a=> selAno.innerHTML+=`<option>${a}</option>`);
      selAno.onchange = ()=>{
        const ano = selAno.value.substring(2);
        const selMes = document.getElementById('selectMes');
        selMes.innerHTML='';
        arquivos.forEach(nome=>{
          const p=nome.split('.');
          if(p[0]==='mensal'&&p[2]===ano) selMes.innerHTML+=`<option value='${p[1]}'>${new Date(20+p[2],p[1]-1,1).toLocaleString('pt-BR',{month:'long'})}</option>`;
        });
      }
    }
    function popularAnos() {
      const selB=document.getElementById('anoBase'), selC=document.getElementById('anoComp');
      const anos = new Set(); arquivos.forEach(nome=>{ const p=nome.split('.'); if(p[0]==='mensal') anos.add('20'+p[2]); });
      [...anos].sort().forEach(a=>{ selB.innerHTML+=`<option>${a}</option>`; selC.innerHTML+=`<option>${a}</option>`; });
    }

    // -------- Fun√ß√µes de gera√ß√£o de gr√°ficos --------
    async function gerarDiarioMulti(isMulti) {
      const dataInput = isMulti
        ? Array.from(document.getElementById('dataMulti').selectedOptions).map(opt=>opt.value)
        : [document.getElementById('inputData').value];
      if(!dataInput.length) return alert('Selecione pelo menos uma data');
      // Carregar e processar m√∫ltiplos arquivos de acordo com dataInput e turnoSelecionado
      const promises = dataInput.map(dt=> carregarData(dt, turnoSelecionado));
      const datasets = await Promise.all(promises);
      // Calcular compara√ß√£o dia a dia ou an√°lises plurais
      renderComparativoDias(dataInput, datasets);
    }
    async function carregarData(dateStr, turno) {
      // Converte e monta nome e fetch JSON...
      // Deve retornar lista de { produto, realizado, quilos, caixas, meta }
      return []; // placeholder
    }

    function renderComparativoDias(dates, dataArrays) {
      const card = document.createElement('div'); card.className='chart-card';
      card.innerHTML = `<canvas></canvas>`;
      document.getElementById('charts').appendChild(card);
      const ctx = card.querySelector('canvas').getContext('2d');
      // montar labels e datasets para Chart.js, ex: cada dia como dataset
      new Chart(ctx, {
        type: 'bar', data: {/* ... */}, options: {/* ... */}
      });
    }

    async function gerarMensalMulti(isMulti) {
      const meses = Array.from(document.getElementById('selectMes').selectedOptions).map(o=>o.value);
      const ano = document.getElementById('selectAno').value;
      if(!meses.length) return alert('Selecione ao menos um m√™s');
      // Fetch m√∫ltiplos JSON mensal.turnoX
      // renderComparativoMeses(meses, ano)
    }
    function gerarAnoAno() {
      const anoB=document.getElementById('anoBase').value, anoC=document.getElementById('anoComp').value;
      if(!anoB||!anoC) return;
      // Fetchar, processar e renderizar comparativo anual (gr√°fico linha/barras)
    }

    function exportarPDF() {
      html2pdf().from(document.querySelector('.content')).set({margin:0.4,filename:'relatorio.pdf',jsPDF:{orientation:'landscape'}}).save();
    }

    // Iniciar aplica√ß√£o
    window.onload = iniciar;
  </script>
</body>
</html>