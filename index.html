<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Rendimento Analyzer</title>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@shoelace-style/shoelace@2.15.0/dist/themes/light.css" />
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.9.2/html2pdf.bundle.min.js"></script>
<style>
 /* macOS window */
 :root{
  --win-bg:rgba(249,249,251,.72); --panel:#fff; --border:#d1d1d6; --accent:#0a84ff; --radius:12px; --shadow:0 2px 8px rgba(0,0,0,.15);
  --text:#1c1c1e; --muted:#6e6e73; --positive:#32d74b; --negative:#ff453a;
 }
 @media (prefers-color-scheme:dark){ :root{--win-bg:rgba(28,28,30,.72);--panel:#1c1c1e;--border:#3a3a3c;--accent:#0a84ff;--text:#f2f2f7;--muted:#8e8e93;--shadow:0 2px 8px rgba(0,0,0,.5);} }
 [data-theme="dark"]{ --win-bg:rgba(28,28,30,.72);--panel:#1c1c1e;--border:#3a3a3c;--text:#f2f2f7;--muted:#8e8e93;--shadow:0 2px 8px rgba(0,0,0,.5);} 
 *{box-sizing:border-box;font-family:-apple-system,BlinkMacSystemFont,'SF Pro',Segoe UI,Roboto,Inter,Arial,sans-serif;}
 body{margin:0;background:linear-gradient(120deg,#e5e9f2 0%,#f9f9fb 100%);min-height:100vh;display:flex;align-items:center;justify-content:center;color:var(--text);} 
 main{width:92%;max-width:1500px;background:var(--panel);border:1px solid var(--border);border-radius:var(--radius);box-shadow:var(--shadow);backdrop-filter:saturate(180%) blur(20px);overflow:hidden;}
 header{display:flex;align-items:center;padding:10px 14px;border-bottom:1px solid var(--border);background:var(--win-bg);} 
 .traffic{display:flex;gap:6px;margin-right:10px;} .dot{width:12px;height:12px;border-radius:50%;} .red{background:#ff5f57;} .yellow{background:#ffbd2e;} .green{background:#28c940;}
 h1{font-size:15px;font-weight:600;margin:0;color:var(--muted);} 
 /* TOOLBAR */
 #toolbar{display:flex;flex-wrap:wrap;gap:8px;padding:12px 16px;border-bottom:1px solid var(--border);} 
 button{appearance:none;-webkit-appearance:none;background:var(--panel);color:var(--text);padding:6px 14px;border:1px solid var(--border);border-radius:8px;font-size:14px;cursor:pointer;transition:.15s;} 
 button:hover{background:rgba(0,0,0,.05);} button.active{background:var(--accent);color:#fff;border-color:var(--accent);} 
 button.icon{padding:6px;} button.icon svg{width:18px;height:18px;fill:currentColor;}
 /* CONTROL GRID */
 #controls{display:flex;gap:10px;flex-wrap:wrap;padding:14px 16px;border-bottom:1px solid var(--border);}
 select,input[type=date]{padding:6px 10px;border:1px solid var(--border);border-radius:6px;font-size:14px;background:var(--panel);color:var(--text);} 
 /* STATUS / INFO */
 #status{padding:12px 16px;font-size:13px;color:var(--muted);} #info{padding:16px 16px;font-size:14px;border-bottom:1px solid var(--border);}
 /* TABLE */
 #tableWrap{overflow-x:auto;padding:0 16px;} table{width:100%;border-collapse:collapse;margin-top:14px;font-size:13px;} th,td{border:1px solid var(--border);padding:6px 10px;} th{background:var(--win-bg);text-align:left;} td.num,th.num{text-align:right;} .pos{color:var(--positive);font-weight:600;} .neg{color:var(--negative);font-weight:600;} .na{color:var(--muted);} 
 /* CHARTS */
 #charts{padding:20px 16px;display:flex;flex-direction:column;gap:26px;} .cBox{border:1px solid var(--border);border-radius:var(--radius);padding:10px;background:var(--panel);} canvas{max-height:48vh;}
 /* FOOTER */
 footer{display:flex;justify-content:center;padding:12px 16px;font-size:12px;color:var(--muted);} 
 .hidden{display:none !important;}
</style>
</head>
<body>
<main>
 <header><div class="traffic"><div class="dot red"></div><div class="dot yellow"></div><div class="dot green"></div></div><h1>Rendimento Analyzer</h1></header>
 <div id="toolbar">
  <button id="bDia" class="active">Dia</button>
  <button id="bDias">Dias (2)</button>
  <button id="bMes">Mês</button>
  <button id="bMeses">Meses (2)</button>
  <button id="bAno">Ano × Ano</button>
  <button id="bTurno" class="icon" title="Alternar Turno">
   <svg viewBox="0 0 24 24"><path d="M12 4a8 8 0 1 0 8 8H4a8 8 0 0 0 8-8zm0-2a10 10 0 1 1 0 20 10 10 0 0 1 0-20z"/></svg>
  </button>
  <button id="bTheme" class="icon" title="Tema"><svg viewBox="0 0 24 24"><path d="M12 2v20M2 12h20" stroke="currentColor" stroke-width="2" fill="none"/></svg></button>
  <button id="bExport" class="icon" title="Exportar PDF"><svg viewBox="0 0 24 24"><path d="M6 2h9l5 5v15a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2z" fill="none" stroke="currentColor" stroke-width="2"/><path d="M14 2v6h6" fill="none" stroke="currentColor" stroke-width="2"/></svg></button>
 </div>
 <div id="controls"></div>
 <div id="status"></div>
 <div id="info" class="hidden"></div>
 <div id="tableWrap"></div>
 <div id="charts" class="hidden">
   <div class="cBox"><canvas id="chartProdutos"></canvas></div>
   <div class="cBox hidden" id="chartIndustrialBox"><canvas id="chartIndustrial"></canvas></div>
 </div>
 <footer>© 2025 Adriano Tools</footer>
</main>
<script>
const META=81.600;let arquivos=[],basePath="",turno='turno1';let mode='Dia';
const qs=s=>document.querySelector(s);const qsa=s=>Array.from(document.querySelectorAll(s));
// Fetch manifest
(async()=>{try{qs('#status').textContent='⏳ Carregando index.json…';const r=await fetch('index.json');const j=await r.json();arquivos=j.arquivos||[];basePath=location.href.replace(/[^/]*$/,'');qs('#status').textContent='';initControls();}catch(e){qs('#status').textContent='❌ Erro ao carregar index.json';console.error(e);}})();
function initControls(){renderControlBar();['#bDia','#bDias','#bMes','#bMeses','#bAno'].forEach(id=>qs(id).addEventListener('click',()=>{mode=id.slice(2);qsa('#toolbar button').forEach(b=>b.classList.remove('active'));qs(id).classList.add('active');renderControlBar();}));
 qs('#bTurno').onclick=()=>{turno=turno==='turno1'?'turno2':'turno1';renderControlBar();};
 qs('#bTheme').onclick=()=>{document.documentElement.dataset.theme=document.documentElement.dataset.theme==='dark'?'light':'dark';};
 qs('#bExport').onclick=()=>{html2pdf().from(document.querySelector('main')).set({margin:.4,filename:'rendimento.pdf',image:{type:'jpeg',quality:.96},html2canvas:{scale:2},jsPDF:{unit:'in',format:'a4',orientation:'landscape'}}).save();};
}
function renderControlBar(){const c=qs('#controls');c.innerHTML='';const btn=document.createElement('button');btn.textContent='Carregar';btn.className='active';btn.style.marginLeft='auto'; // push right
 if(mode==='Dia'||mode==='Dias'){const d1=inputDate('data1');c.append(d1);if(mode==='Dias'){const d2=inputDate('data2');c.append(d2);}c.append(btn);btn.onclick=()=>loadDia(mode==='Dias');}
 else if(mode==='Mês'||mode==='Meses'||mode==='Ano'){const y1=selectAno('ano1'),m1=selectMes('mes1');c.append(y1,m1);if(mode!=='Mês'){const y2=selectAno('ano2'),m2=selectMes('mes2');c.append(y2,m2);}c.append(btn);btn.onclick=()=>loadMes(mode!=='Mês');}
 }
function inputDate(id){const inp=document.createElement('input');inp.type='date';inp.id=id;return inp;}
function selectAno(id){const sel=document.createElement('select');sel.id=id;sel.innerHTML='<option value="">Ano</option>'+anosManifest().map(y=>`<option>${y}</option>`).join('');return sel;}
function selectMes(id){const sel=document.createElement('select');sel.id=id;sel.innerHTML='<option value="">Mês</option>'+[...Array(12).keys()].map(i=>`<option value="${i+1}">${i+1}</option>`).join('');return sel;}
function anosManifest(){return [...new Set(arquivos.filter(a=>a.startsWith('mensal')).map(a=>2000+parseInt(a.split('.')[2])) )].sort((a,b)=>b-a);} 
// Helpers filename
function fileDia(dateISO,t){const d=new Date(dateISO+'T00:00:00Z');const nome=d.toLocaleDateString('pt-BR',{weekday:'long',timeZone:'UTC'}).toLowerCase().replace('terça','terca').replace('sábado','sabado');const dd=String(d.getUTCDate()).padStart(2,'0');const mm=String(d.getUTCMonth()+1).padStart(2,'0');const aa=String(d.getUTCFullYear()).slice(2);return `${nome}.${dd}.${mm}.${aa}.${t}.json`;}
function fileMes(m,a,t){const mm=String(m).padStart(2,'0');const aa=String(a).slice(2);return `mensal.${mm}.${aa}.${t}.json`;}
function tituloMes(m,a){return new Date(a,m-1,1).toLocaleString('pt-BR',{month:'long'}).replace(/^./,c=>c.toUpperCase())+'/'+a;}
// Loaders
async function loadDia(duplo){const d1=qs('#data1').value;const d2=duplo?qs('#data2').value:null;if(!d1||(duplo&&!d2)){alert('Selecione as datas');return;}const files=[fileDia(d1,turno)];const labels=[new Date(d1).toLocaleDateString('pt-BR')];if(duplo){files.push(fileDia(d2,turno));labels.push(new Date(d2).toLocaleDateString('pt-BR'));} await process(files,labels,false);
}
async function loadMes(duplo){const y1=qs('#ano1').value,m1=qs('#mes1').value;if(!y1||!m1){alert('Selecione ano e mês');return;}const files=[fileMes(m1,y1,turno)];const labels=[tituloMes(m1,y1)];if(duplo){const y2=qs('#ano2').value,m2=qs('#mes2').value;if(!y2||!m2){alert('Selecione o segundo mês');return;}files.push(fileMes(m2,y2,mode==='Ano'? 'turno1':turno));labels.push(tituloMes(m2,y2));}await process(files,labels,true);
}
let chartP,chartI;function clearAll(){if(chartP){chartP.destroy();chartP=null;}if(chartI){chartI.destroy();chartI=null;qs('#chartIndustrialBox').classList.add('hidden');}qs('#tableWrap').innerHTML='';qs('#charts').classList.add('hidden');qs('#info').classList.add('hidden');}
async function process(files,labels,isMensal){try{qs('#status').textContent='⌛ Carregando…';clearAll();const dados=await Promise.all(files.map(async f=>{if(!arquivos.includes(f))throw`Arquivo não listado: ${f}`;const res=await fetch(basePath+f);if(!res.ok)throw`${f} – ${res.status}`;return res.json();}));qs('#info').classList.remove('hidden');qs('#info').textContent=labels.join(' × ');
 const produtos=[...new Set(dados.flatMap(d=>d.itens.map(i=>i.produto)))];
 let html='<table><thead><tr><th>Produto</th>'; if(dados.length===1){html+='<th class="num">Meta %</th><th class="num">Realizado %</th><th class="num">Dif %</th><th class="num">Kg</th><th class="num">Cx</th></tr></thead><tbody>';}else{html+=`<th class="num">${labels[0]} %</th><th class="num">${labels[1]} %</th><th class="num">Dif %</th><th class="num">Dif Kg</th><th class="num">Dif Cx</th></tr></thead><tbody>`;}
 const metas=[],v1=[],v2=[];
 produtos.forEach(p=>{const d1=dados[0].itens.find(i=>i.produto===p)||{};const d2=dados[1]?dados[1].itens.find(i=>i.produto===p)||{}:{};const meta=d1.meta||d2.meta||0;const r1=+d1.realizado||0;const r2=dados.length>1?(+d2.realizado||0):0;metas.push(meta);v1.push(r1);if(dados.length>1)v2.push(r2);
 html+=`<tr><td>${p}</td>`;
 if(dados.length===1){const diff=r1-meta;const cls=diff>0?'pos':diff<0?'neg':'na';html+=`<td class="num">${meta.toFixed(3)}%</td><td class="num">${r1.toFixed(3)}%</td><td class="num ${cls}">${diff.toFixed(3)}%</td><td class="num">${(+d1.quilos||0).toFixed(2)}</td><td class="num">${Math.round(+d1.caixas||0)}</td>`;}else{const diff=r2-r1;const cls=diff>0?'pos':diff<0?'neg':'na';html+=`<td class="num">${r1.toFixed(3)}%</td><td class="num">${r2.toFixed(3)}%</td><td class="num ${cls}">${diff.toFixed(3)}%</td><td class="num ${cls}">${((+d2.quilos||0)-(+d1.quilos||0)).toFixed(2)}</td><td class="num ${cls}">${(Math.round(+d2.caixas||0)-Math.round(+d1.caixas||0))}</td>`;} html+='</tr>';});html+='</tbody></table>'; qs('#tableWrap').innerHTML=html;
 // Chart produtos
 const ctx=qs('#chartProdutos').getContext('2d');const ds=[{label:'Meta %',data:metas,backgroundColor:'rgba(255,159,64,.6)'} ,{label:labels[0],data:v1,backgroundColor:'rgba(0,122,255,.6)'}];if(dados.length>1)ds.push({label:labels[1],data:v2,backgroundColor:'rgba(48,209,88,.6)'});
 chartP=new Chart(ctx,{type:'bar',data:{labels:produtos,datasets:ds},options:{plugins:{legend:{position:'top'},title:{display:true,text:'Meta × Realizado'}}}});
 if(isMensal){qs('#chartIndustrialBox').classList.remove('hidden');const ctx2=qs('#chartIndustrial').getContext('2d');const ind=[META].concat(dados.map(d=>d.rendimentoIndustrial||0));chartI=new Chart(ctx2,{type:'bar',data:{labels:['Meta'].concat(labels),datasets:[{label:'Rend.Industrial %',data:ind,backgroundColor:['#ff9f0a','#0a84ff','#32d74b']}]},options:{plugins:{legend:{display:false},title:{display:true,text:'Rendimento Industrial'}}}});}
 qs('#charts').classList.remove('hidden');qs('#status').textContent='';}catch(e){qs('#status').textContent='❌ '+e;console.error(e);} }
</script>
</body>
</html>
