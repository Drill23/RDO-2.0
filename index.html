<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Plataforma Avan√ßada de An√°lise de Rendimento</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script> <!-- Chart.js v3 √© recomendado -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script> <!-- Vers√£o mais recente do html2pdf -->
    <style>
        /* --- Paleta de Cores e Vari√°veis --- */
        :root {
            --primary-bg: #f8f9fa; /* Cinza mais claro */
            --secondary-bg: #ffffff;
            --header-bg: #e9ecef;
            --table-header-bg: #dee2e6;
            --accent-blue: #007bff;
            --accent-green: #28a745;
            --accent-yellow: #ffc107;
            --accent-purple: #6f42c1;
            --accent-orange: #fd7e14;
            --accent-red: #dc3545;
            --accent-cyan: #17a2b8; /* Nova cor para compara√ß√µes */
            --accent-grey: #6c757d;
            --text-color: #212529; /* Preto mais suave */
            --border-color: #ced4da;
            --shadow-color: rgba(0, 0, 0, 0.1);
            --positive: #28a745; /* Verde */
            --negative: #dc3545; /* Vermelho */
            --neutral: #6c757d; /* Cinza */
            --meta-color: #ffc107; /* Amarelo para meta */
        }

        /* --- Estilos Globais --- */
        body {
            font-family: 'Segoe UI', -apple-system, BlinkMacSystemFont, Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
            margin: 0;
            padding: 0;
            background-color: var(--primary-bg);
            color: var(--text-color);
            line-height: 1.6;
            font-size: 16px;
        }

        .container {
            max-width: 1400px; /* Aumentar um pouco a largura */
            margin: 25px auto;
            padding: 25px;
            background-color: var(--secondary-bg);
            box-shadow: 0 4px 12px var(--shadow-color);
            border-radius: 10px;
        }

        h1 {
            text-align: center;
            color: var(--accent-blue);
            margin-bottom: 35px;
            font-weight: 600;
            letter-spacing: -0.5px;
            page-break-after: avoid;
        }
        h2, h3, h4 {
            color: var(--accent-grey);
            margin-top: 1.5em;
            margin-bottom: 0.8em;
            page-break-after: avoid;
        }
        h3 { font-size: 1.3em; font-weight: 500; }
        h4 { font-size: 1.1em; font-weight: 500; border-bottom: 1px solid var(--border-color); padding-bottom: 5px; margin-bottom: 15px;}

        /* --- Menu e A√ß√µes --- */
        .menu, .acoes {
            text-align: center;
            margin-bottom: 30px;
        }
        .menu-section {
            margin-bottom: 20px;
            padding-bottom: 20px;
            border-bottom: 1px solid var(--header-bg);
        }
         .menu-section:last-child { border-bottom: none; margin-bottom: 0; padding-bottom: 0; }
         .menu-section h3 { margin-bottom: 15px; }

        button {
            padding: 10px 22px;
            margin: 6px 8px;
            font-size: 0.95em; /* Levemente menor */
            font-weight: 500;
            cursor: pointer;
            border: none;
            border-radius: 6px;
            color: white;
            transition: all 0.25s ease;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            vertical-align: middle;
        }
        button:hover { transform: translateY(-2px); box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15); opacity: 1; }
        button:active { transform: translateY(0); box-shadow: 0 1px 2px rgba(0, 0, 0, 0.1); }

        /* --- Estilos dos Bot√µes (Cores e A√ß√µes) --- */
        .btn-t1 { background-color: var(--accent-blue); }
        .btn-t1:hover { background-color: #0056b3; }
        .btn-t2 { background-color: var(--accent-green); }
        .btn-t2:hover { background-color: #1e7e34; }
        .btn-comparar { background-color: var(--accent-cyan); } /* Cor unificada para compara√ß√µes */
        .btn-comparar:hover { background-color: #117a8b; }
        .btn-pdf { background-color: var(--accent-red); }
        .btn-pdf:hover { background-color: #bd2130; }
        .btn-voltar, .btn-cancelar { background-color: var(--accent-grey); }
        .btn-voltar:hover, .btn-cancelar:hover { background-color: #545b62; }
        .btn-carregar { background-color: var(--accent-orange); } /* Laranja para carregar */
        .btn-carregar:hover { background-color: #d96a0d; }

        /* √çcones simples (pode substituir por SVGs ou Font Awesome se preferir) */
        button::before {
            margin-right: 8px;
            font-weight: normal;
            display: inline-block;
        }
        .btn-t1::before { content: 'üîµ'; }
        .btn-t2::before { content: 'üü¢'; }
        .btn-comparar.diario::before { content: 'üü°'; } /* Amarelo para comparar dia */
        .btn-comparar.semanal::before { content: 'üü£'; } /* Roxo para comparar semana */
        .btn-comparar.mensal::before { content: 'üüß'; } /* Laranja para comparar m√™s */
        .btn-comparar.mes-ano::before { content: 'üìÖ'; } /* Novo √≠cone para m√™s/ano */
        .btn-pdf::before { content: 'üìÑ'; }
        .btn-voltar::before { content: 'üîô'; }
        .btn-carregar::before { content: '‚ö°'; }
        .btn-cancelar::before { content: '‚ùå';}

        /* --- Seletor de Per√≠odo --- */
         #seletorPeriodoContainer {
            padding: 20px;
            background-color: var(--secondary-bg);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            margin-bottom: 30px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
         }
         #seletorPeriodoContainer h4 {
             margin-top: 0;
             margin-bottom: 20px;
             text-align: center;
             color: var(--accent-grey);
         }
         .seletor-grupo {
             display: flex;
             flex-wrap: wrap;
             align-items: center;
             justify-content: center;
             gap: 15px; /* Espa√ßamento entre elementos */
             margin-bottom: 15px;
             padding-bottom: 15px;
             border-bottom: 1px dashed var(--border-color);
         }
        .seletor-grupo:last-child { border-bottom: none; margin-bottom: 0; }
         .seletor-item {
             display: flex;
             flex-direction: column; /* Label acima do input */
             align-items: flex-start;
         }
         .seletor-item label {
            margin-bottom: 5px;
            font-weight: 500;
            font-size: 0.9em;
            color: #495057;
         }
         .seletor-item input[type="date"], .seletor-item select {
            padding: 9px 12px;
            border: 1px solid var(--border-color);
            border-radius: 5px;
            font-size: 0.95em;
            min-width: 180px; /* Largura m√≠nima */
            background-color: #fff;
         }
         .seletor-acoes {
             text-align: center;
             margin-top: 20px;
         }
         .seletor-divisor { /* Divisor visual para compara√ß√µes */
            font-size: 1.5em;
            font-weight: bold;
            color: var(--accent-cyan);
            align-self: center; /* Centraliza o 'VS' */
            margin: 0 10px;
         }

        /* --- √Årea de Conte√∫do e Status --- */
        .info {
            font-size: 1.25em; /* Um pouco maior */
            font-weight: 600;
            margin-bottom: 25px;
            padding: 18px 25px;
            background-color: var(--header-bg);
            border-left: 5px solid var(--accent-blue); /* Barra de destaque */
            border-radius: 8px;
            text-align: center;
            page-break-after: avoid;
        }
         .info span { display: block; font-size: 0.8em; font-weight: 400; color: var(--accent-grey); margin-top: 5px;} /* Subt√≠tulo menor */

        #status {
            text-align: center;
            font-style: italic;
            color: var(--accent-grey);
            margin: 25px;
            padding: 10px;
            border-radius: 5px;
            background-color: var(--header-bg);
            display: none; /* Come√ßa oculto */
        }
        #status.loading { color: var(--accent-orange); display: block; }
        #status.error { color: var(--accent-red); font-weight: bold; display: block; }
        #status.success { color: var(--accent-green); display: block; } /* Opcional */

        .content-area {
            background-color: #fff;
            padding: 25px;
            border-radius: 8px;
            /* box-shadow: 0 2px 5px rgba(0,0,0,0.05); */ /* Sombra j√° est√° no container */
            margin-top: 20px;
            position: relative;
        }

        /* --- Tabelas --- */
        table {
            margin: 25px auto;
            border-collapse: separate; /* Mudar para separate para usar border-spacing */
            border-spacing: 0; /* Resetar espa√ßamento */
            width: 100%;
            background: #fff;
            box-shadow: 0 3px 8px var(--shadow-color);
            border-radius: 8px;
            overflow: hidden; /* Garante que o border-radius funcione */
            font-size: 0.9em;
            page-break-inside: auto;
        }
        tr { page-break-inside: avoid !important; page-break-after: auto; }
        thead { display: table-header-group; background-color: var(--table-header-bg); }
        tbody { display: table-row-group; }

        th, td {
            border-bottom: 1px solid var(--border-color); /* Linha apenas abaixo */
            padding: 10px 12px; /* Mais padding */
            text-align: left;
            vertical-align: middle;
        }
        th {
            font-weight: 600; /* Mais forte */
            text-transform: uppercase;
            font-size: 0.85em;
            letter-spacing: 0.06em;
            white-space: nowrap;
            border-bottom-width: 2px; /* Linha mais grossa abaixo do header */
            border-color: darken(var(--table-header-bg), 10%);
        }
        tbody tr:last-child td { border-bottom: none; } /* Remover borda da √∫ltima linha */
        tbody tr:hover { background-color: var(--primary-bg); } /* Hover suave */

        td.numeric, th.numeric { text-align: right; white-space: nowrap; font-variant-numeric: tabular-nums; } /* Alinha n√∫meros */
        td.center, th.center { text-align: center; }
        td.indicator { font-weight: bold; } /* Destaque para indicadores */

        .positivo { color: var(--positive); }
        .negativo { color: var(--negative); }
        .neutro { color: var(--neutral); } /* Renomeado de na-meta */
        .positivo i::before { content: '‚ñ≤ '; } /* √çcone de subida */
        .negativo i::before { content: '‚ñº '; } /* √çcone de descida */
        .neutro i::before { content: '‚óè '; } /* √çcone neutro */

        /* --- Resumos e An√°lises --- */
        .summary-section {
            margin-top: 30px;
            padding: 20px;
            background-color: #eef5ff; /* Fundo azul claro */
            border-left: 5px solid var(--accent-blue);
            border-radius: 6px;
            font-size: 1.05em;
            page-break-inside: avoid !important;
        }
        .summary-section h4 {
            margin-top: 0;
            color: var(--accent-blue);
            border-bottom: none; /* Remover borda do h4 dentro do resumo */
        }
        .summary-section strong { font-weight: 600; }
        .summary-section ul { list-style: none; padding-left: 0; }
        .summary-section li { margin-bottom: 8px; }
        .summary-section li::before { /* Adicionar marcadores visuais */
            content: '‚Ä¢';
            color: var(--accent-blue);
            display: inline-block;
            width: 1em;
            margin-left: -1em;
        }
        .ri-summary { border-left-color: var(--accent-orange); background-color: #fff8e1; } /* Destaque para RI */
        .ri-summary h4 { color: var(--accent-orange); }
        .ri-summary li::before { color: var(--accent-orange); }

        /* --- Gr√°ficos --- */
        .charts-grid { /* Usar grid para layout dos gr√°ficos */
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr)); /* Responsivo */
            gap: 25px;
            margin-top: 30px;
        }
        .chart-container {
             position: relative;
             background: #fff;
             padding: 20px;
             border-radius: 8px;
             box-shadow: 0 3px 8px var(--shadow-color);
             page-break-inside: avoid !important;
             page-break-before: auto;
             overflow: hidden;
             min-height: 350px; /* Altura m√≠nima para evitar esmagamento */
        }
         .chart-container h4 { /* T√≠tulo dentro do container do gr√°fico */
             text-align: center;
             margin-top: 0;
             margin-bottom: 15px;
             font-size: 1em;
             color: var(--accent-grey);
         }
        canvas {
            display: block;
            max-width: 100%;
            height: auto !important; /* Deixar Chart.js controlar */
        }

        /* --- Estilos PDF --- */
        @media print {
           body {
               -webkit-print-color-adjust: exact !important;
               color-adjust: exact !important;
               font-size: 9pt;
               background-color: #fff; /* Fundo branco para impress√£o */
           }
           .container { box-shadow: none; border: none; margin: 0; padding: 0; max-width: 100%; border-radius: 0;}
           button, .menu, .acoes, #seletorPeriodoContainer { display: none !important; }
           .content-area { box-shadow: none; border: none; padding: 0; margin: 0; }
           .chart-container { box-shadow: none; border: 1px solid var(--border-color); padding: 10px; }
           .charts-grid { grid-template-columns: 1fr; gap: 15px; } /* Empilhar gr√°ficos no PDF */
           .info { border-left: none; background-color: transparent; padding: 10px 0; margin-bottom: 15px;}
           h1, .info { page-break-after: avoid; }
           .summary-section { background-color: #f0f0f0; border-left-width: 3px; padding: 10px; }
           .acoes-visao { display: none !important; }
           table { font-size: 8pt; box-shadow: none; border: 1px solid var(--border-color); }
           th, td { padding: 5px 6px; }
           :root { /* Usar cores mais seguras para impress√£o se necess√°rio, mas exact tenta manter */
               --text-color: #000;
           }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üìä Plataforma Avan√ßada de An√°lise de Rendimento</h1>

        <div class="menu">
             <div class="menu-section">
                <h3>An√°lise Individual</h3>
                <button class="btn-t1" onclick="selecionarPeriodo('diario1')">Di√°rio T1</button>
                <button class="btn-t2" onclick="selecionarPeriodo('diario2')">Di√°rio T2</button>
                <button class="btn-t1" onclick="selecionarPeriodo('semanal1')">Semanal T1</button>
                <button class="btn-t2" onclick="selecionarPeriodo('semanal2')">Semanal T2</button>
                <button class="btn-t1" onclick="selecionarPeriodo('mensal1')">Mensal T1</button>
                <button class="btn-t2" onclick="selecionarPeriodo('mensal2')">Mensal T2</button>
            </div>
            <div class="menu-section">
                <h3>An√°lises Comparativas</h3>
                <button class="btn-comparar diario" onclick="selecionarPeriodo('comparar_dia')">Comparar Dias (T1 vs T2)</button>
                <button class="btn-comparar diario" onclick="selecionarPeriodo('comparar_dias_turno')">Comparar Dias (Mesmo Turno)</button>
                <button class="btn-comparar semanal" onclick="selecionarPeriodo('comparar_semana')">Comparar Semanas (T1 vs T2)</button>
                <button class="btn-comparar mensal" onclick="selecionarPeriodo('comparar_mes')">Comparar Meses (T1 vs T2)</button>
                <button class="btn-comparar mensal" onclick="selecionarPeriodo('comparar_meses_turno')">Comparar Meses (Mesmo Turno)</button>
                <button class="btn-comparar mes-ano" onclick="selecionarPeriodo('comparar_mes_ano')">Comparar M√™s (Ano vs Ano)</button>
            </div>
        </div>

        <!-- √Årea de Sele√ß√£o de Per√≠odo (Din√¢mica) -->
        <div id="seletorPeriodoContainer" style="display:none;">
             <h4>Selecione o(s) Per√≠odo(s) para <span id="tipoAnaliseSelecionada">An√°lise</span></h4>
             <div id="seletores">
                 <!-- Seletores ser√£o adicionados dinamicamente aqui -->
             </div>
             <div class="seletor-acoes">
                 <button class="btn-carregar" onclick="carregarDadosSelecionados()">Carregar Dados</button>
                 <button class="btn-cancelar" onclick="cancelarSelecao()">Cancelar</button>
             </div>
        </div>

        <div id="status"></div> <!-- Status de carregamento/erro -->
        <div class="acoes">
             <button class="btn-voltar voltar" onclick="voltarMenu()" style="display:none;">Voltar ao Menu Principal</button>
        </div>

        <div class="content-area" id="contentArea" style="display:none;">
            <div id="info" class="info" style="display:none;"></div> <!-- T√≠tulo da An√°lise -->
            <div id="resultado"></div> <!-- Tabela e Resumos aqui -->

            <!-- Grid para Gr√°ficos -->
            <div class="charts-grid">
                <div id="graficoPrincipalContainer" class="chart-container" style="display:none;">
                    <h4 id="graficoPrincipalTitulo">Gr√°fico Principal</h4>
                    <canvas id="graficoPrincipal"></canvas>
                </div>
                <div id="graficoRIContainer" class="chart-container" style="display:none;">
                     <h4>An√°lise de Rendimento Industrial (RI)</h4>
                     <canvas id="graficoRI"></canvas>
                </div>
                <div id="graficoDiferencaContainer" class="chart-container" style="display:none;">
                     <h4>Diferen√ßas por Produto (%)</h4>
                     <canvas id="graficoDiferenca"></canvas>
                </div>
                <!-- Adicionar mais containers de gr√°fico se necess√°rio -->
            </div>

             <div class="acoes-visao" style="text-align: center; margin-top: 30px; padding-top: 20px; border-top: 1px solid var(--border-color);">
                 <button class="btn-pdf btn-pdf-visao" onclick="exportarPDF_VisaoAtual()" style="display:none;">Exportar Esta Vis√£o em PDF</button>
             </div>
        </div>

    </div>

<script>
    const META_RI = 81.600; // Meta de Rendimento Industrial

    let dados = {}; // Armazena dados carregados para a vis√£o ATUAL (pode ter periodo1, periodo2)
    let arquivosDisponiveis = []; // Lista de TODOS os nomes de arquivos do index.json
    let tipoAnaliseAtual = null; // Guarda o tipo de an√°lise selecionado
    let graficoPrincipalInstancia = null;
    let graficoRIInstancia = null;
    let graficoDiferencaInstancia = null;

    // --- Fun√ß√µes Utilit√°rias ---
    function destruirGraficos() {
        if (graficoPrincipalInstancia) { graficoPrincipalInstancia.destroy(); graficoPrincipalInstancia = null; }
        if (graficoRIInstancia) { graficoRIInstancia.destroy(); graficoRIInstancia = null; }
        if (graficoDiferencaInstancia) { graficoDiferencaInstancia.destroy(); graficoDiferencaInstancia = null; }
        document.getElementById("graficoPrincipalContainer").style.display = "none";
        document.getElementById("graficoRIContainer").style.display = "none";
        document.getElementById("graficoDiferencaContainer").style.display = "none";
    }

    function formatPercent(value) {
        return value.toLocaleString('pt-BR', { minimumFractionDigits: 3, maximumFractionDigits: 3 }) + '%';
    }

    function formatKg(value) {
        return value.toLocaleString('pt-BR', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
    }

    function formatCx(value) {
        return Math.round(value).toLocaleString('pt-BR');
    }

    function getSignClass(value, threshold = 0.0001) {
        if (value > threshold) return 'positivo';
        if (value < -threshold) return 'negativo';
        return 'neutro';
    }

    function getSignIndicator(value, threshold = 0.0001) {
        if (value > threshold) return '<i class="positivo"></i>';
        if (value < -threshold) return '<i class="negativo"></i>';
        return '<i class="neutro"></i>';
    }

    function extrairInfo(nomeArquivo) {
        // (Mantida a fun√ß√£o original, mas adicionando retorno de `rendimento_industrial` se existir no JSON)
        if (!nomeArquivo) return { nome: 'N/A', tipo: 'N/A', diaSemana: 'N/A', data: 'N/A', turno: 'N/A', mes: 'N/A', ano: 'N/A', tituloPeriodo: 'N/A', rendimento_industrial: null };
        const partes = nomeArquivo.replace('.json', '').split('.');
        let tipo = 'N/A', turno = 'N/A', diaSemana = 'N/A', data = 'N/A', tituloPeriodo = 'N/A', mes = 'N/A', ano = 'N/A', periodoSemana = 'N/A';

        turno = partes.includes("turno1") ? "Turno 1" : (partes.includes("turno2") ? "Turno 2" : "N/A");

        if (partes[0] === "semana" && partes.length >= 5) {
            tipo = "semanal";
            periodoSemana = partes[1].replace('a', ' a ');
            mes = partes[2];
            ano = "20" + partes[3];
            tituloPeriodo = `Semana ${periodoSemana}/${mes}/${ano}`;
            data = `${mes}/${ano}`;
        } else if (partes[0] === "mensal" && partes.length >= 4) {
            tipo = "mensal";
            mes = partes[1];
            ano = "20" + partes[2];
            try {
                 const nomeMes = new Date(parseInt(ano), parseInt(mes) - 1, 1).toLocaleString('pt-BR', { month: 'long' });
                 tituloPeriodo = `${nomeMes.charAt(0).toUpperCase() + nomeMes.slice(1)}/${ano}`;
            } catch (e) { tituloPeriodo = `M√™s ${mes}/${ano}`; }
            data = `${mes}/${ano}`;
        } else if (partes.length >= 5) {
             tipo = "diario";
             let diaNome = partes[0]; let offset = 0;
             if (partes[1] === "feira") { diaSemana = diaNome.charAt(0).toUpperCase() + diaNome.slice(1) + "-feira"; offset = 1; }
             else { diaSemana = diaNome.charAt(0).toUpperCase() + diaNome.slice(1); }
             const diaNum = partes[1 + offset]; mes = partes[2 + offset]; ano = "20" + partes[3 + offset];
             data = `${diaNum}/${mes}/${ano}`;
             tituloPeriodo = `${diaSemana}, ${data}`;
        }

        // Rendimento industrial ser√° adicionado ao carregar os dados, n√£o extra√≠do do nome do arquivo.
        return { nome: nomeArquivo, tipo, diaSemana, data, turno, mes, ano, periodoSemana, tituloPeriodo, rendimento_industrial: null };
    }

    // Op√ß√µes Padr√£o para Gr√°ficos (Chart.js v3)
    function commonChartOptions(titleText) {
        return {
            responsive: true,
            maintainAspectRatio: false, // Importante para o container controlar o tamanho
            plugins: {
                title: { display: true, text: titleText, font: { size: 14 }, padding: { top: 10, bottom: 20 } },
                legend: { position: 'bottom', labels: { padding: 20, boxWidth: 12, font: { size: 11 } } },
                tooltip: {
                    backgroundColor: 'rgba(0, 0, 0, 0.8)',
                    titleFont: { size: 13 },
                    bodyFont: { size: 12 },
                    padding: 10,
                    callbacks: {
                        label: function(context) {
                            let label = context.dataset.label || '';
                            if (label) { label += ': '; }
                            let value = context.parsed.y;
                            if (value !== null && !isNaN(value)) {
                                // Adapta a formata√ß√£o baseada no tipo de gr√°fico (pode ser melhorado)
                                if (context.chart.canvas.id === 'graficoRI' || (context.dataset.label && context.dataset.label.includes('%'))) {
                                     label += formatPercent(value);
                                } else if (context.chart.canvas.id === 'graficoDiferenca') {
                                     label += (value >= 0 ? '+' : '') + formatPercent(value);
                                }
                                else {
                                     label += value.toLocaleString('pt-BR'); // Formata√ß√£o gen√©rica
                                }
                            } else { label += 'N/D'; }
                            return label;
                        }
                    }
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: {
                        font: { size: 11 },
                        // Formata√ß√£o condicional para o eixo Y
                        callback: function(value, index, ticks) {
                            // Heur√≠stica: Se a maioria dos dados for < 100 ou se for RI, assume porcentagem
                            const isPercentLike = this.chart.canvas.id.includes('RI') || this.chart.canvas.id.includes('Diferenca') || (this.chart.data.datasets.length > 0 && Math.max(...this.chart.data.datasets[0].data.filter(v => !isNaN(v))) < 150);
                            return isPercentLike ? value + '%' : value.toLocaleString('pt-BR');
                        }
                    },
                    grid: { color: '#e9ecef' } // Linhas de grade mais suaves
                },
                x: {
                    ticks: { font: { size: 11 }, autoSkip: false, maxRotation: 60, minRotation: 0 },
                    grid: { display: false } // Sem linhas de grade verticais
                }
            },
            animation: { duration: 300 } // Anima√ß√£o sutil
        };
    }

    // --- Fun√ß√µes de Exibi√ß√£o ---

    function mostrarCabecalho(info1, info2 = null, tipoComparacao = null) {
        const div = document.getElementById("info");
        let titulo = "";
        let subtitulo = "";
        const iconeT1 = 'üîµ';
        const iconeT2 = 'üü¢';

        if (info2) { // Comparativo
            const tipoBase = info1.tipo.charAt(0).toUpperCase() + info1.tipo.slice(1); // Diario, Semanal, Mensal
            const icone1 = info1.turno === 'Turno 1' ? iconeT1 : iconeT2;
            const icone2 = info2.turno === 'Turno 1' ? iconeT1 : iconeT2;
            let vsTexto = `${icone1} ${info1.turno}`;
            let periodoTexto = `(${info1.tituloPeriodo})`;

            // Ajusta o texto para diferentes tipos de compara√ß√£o
            if (tipoComparacao === 'comparar_dia' || tipoComparacao === 'comparar_semana' || tipoComparacao === 'comparar_mes') { // T1 vs T2 mesmo per√≠odo
                 titulo = `üìä Comparativo ${tipoBase} ${info1.turno} vs ${info2.turno}`;
                 subtitulo = `${info1.tituloPeriodo}`;
                 vsTexto = `${icone1} ${info1.turno} vs ${icone2} ${info2.turno}`;
            } else if (tipoComparacao === 'comparar_dias_turno' || tipoComparacao === 'comparar_meses_turno') { // Mesmo turno, per√≠odos diferentes
                 titulo = `üîÅ Comparativo ${tipoBase} ${info1.turno}`;
                 subtitulo = `${info1.tituloPeriodo} vs ${info2.tituloPeriodo}`;
                 vsTexto = `${icone1} (${info1.tituloPeriodo}) vs ${icone1} (${info2.tituloPeriodo})`; // Reusa √≠cone
            } else if (tipoComparacao === 'comparar_mes_ano') { // Mesmo m√™s/turno, anos diferentes
                 titulo = `üìÖ Comparativo ${tipoBase} ${info1.turno} (Ano vs Ano)`;
                 subtitulo = `${info1.tituloPeriodo} vs ${info2.tituloPeriodo}`;
                 vsTexto = `${icone1} ${info1.tituloPeriodo} vs ${icone1} ${info2.tituloPeriodo}`;
            }
            div.innerHTML = `${titulo}<span>${subtitulo}</span>`;

        } else { // Individual
            const tipoRelatorio = info1.tipo.charAt(0).toUpperCase() + info1.tipo.slice(1);
            const corIcone = info1.turno === 'Turno 1' ? iconeT1 : iconeT2;
            titulo = `üìÑ Relat√≥rio ${tipoRelatorio} ${info1.turno}`;
            subtitulo = info1.tituloPeriodo;
            div.innerHTML = `${titulo}<span>${subtitulo}</span>`;
        }
        div.style.display = 'block';
    }

    function mostrarAnaliseRI(ri1, info1, ri2, info2) {
        const container = document.getElementById('resultado'); // Adiciona ao resultado principal
        const div = document.createElement('div');
        div.className = 'summary-section ri-summary'; // Classe espec√≠fica para RI

        let html = '<h4>An√°lise de Rendimento Industrial (RI)</h4><ul>';
        const metaRIFormatado = formatPercent(META_RI);

        function compararRI(riValor, infoPeriodo) {
            let liClass = '';
            let texto = '';
            if (riValor === null || riValor === undefined || isNaN(riValor)) {
                 texto = `<li>${infoPeriodo.tituloPeriodo} (${infoPeriodo.turno}): <strong>RI n√£o informado</strong></li>`;
                 liClass = 'neutro';
            } else {
                const riFormatado = formatPercent(riValor);
                const diffMeta = riValor - META_RI;
                const diffMetaFormatado = (diffMeta >= 0 ? '+' : '') + formatPercent(diffMeta);
                const classeMeta = getSignClass(diffMeta);
                texto = `<li>${infoPeriodo.tituloPeriodo} (${infoPeriodo.turno}): <strong>${riFormatado}</strong> `;
                texto += `(<span class="${classeMeta}">${diffMetaFormatado}</span> vs Meta ${metaRIFormatado})</li>`;
                liClass = classeMeta;
            }
            return { texto, liClass };
        }

        const res1 = compararRI(ri1, info1);
        html += res1.texto;

        let riDiff = null;
        if (ri2 !== null && ri2 !== undefined && !isNaN(ri2)) {
            const res2 = compararRI(ri2, info2);
            html += res2.texto;

            // Compara√ß√£o entre os dois per√≠odos
            if (ri1 !== null && ri1 !== undefined && !isNaN(ri1)) {
                 riDiff = ri2 - ri1;
                 const riDiffFormatado = (riDiff >= 0 ? '+' : '') + formatPercent(riDiff);
                 const classeDiff = getSignClass(riDiff);
                 html += `<li>Comparativo (${info2.tituloPeriodo} vs ${info1.tituloPeriodo}): <strong class="${classeDiff}">${riDiffFormatado}</strong></li>`;
            }
        }

        html += '</ul>';
        div.innerHTML = html;
        container.appendChild(div); // Adiciona a an√°lise ao resultado

        // Desenhar gr√°fico de RI se houver dados
        if ((ri1 !== null && !isNaN(ri1)) || (ri2 !== null && !isNaN(ri2))) {
             desenharGraficoRI(ri1, info1, ri2, info2, META_RI);
        }
    }

    function mostrarTabelaComparativa(dados1, info1, dados2, info2, tipoComparacao) {
        const container = document.getElementById('resultado');
        let html = "<table><thead><tr><th>Produto</th>";
        const labels = []; // Labels para gr√°fico de diferen√ßa
        const diffData = []; // Dados para gr√°fico de diferen√ßa (%)

        // Cabe√ßalhos din√¢micos
        const header1 = `${info1.tituloPeriodo} (${info1.turno})`;
        const header2 = `${info2.tituloPeriodo} (${info2.turno})`;
        html += `<th class="numeric">${header1} (%)</th><th class="numeric">${header2} (%)</th><th class="numeric">Dif. (%)</th><th class="numeric">Dif. (Kg)</th><th class="numeric">Dif. (Cx)</th><th class="center">üèÜ Melhor</th></tr></thead><tbody>`;

        let vitorias1 = 0, vitorias2 = 0, empates = 0;
        const produtosProcessados = new Set();
        const comparativoProdutos = []; // Para o gr√°fico de diferen√ßa

        // 1. Processa itens do Per√≠odo 1
        for (let item1 of dados1.produtos) {
             const produto = item1.produto;
             produtosProcessados.add(produto);
             const item2 = dados2.produtos.find(it => it.produto === produto);
             const realizado1 = parseFloat(item1.realizado) || 0;
             const quilos1 = parseFloat(item1.quilos) || 0;
             const caixas1 = parseFloat(item1.caixas) || 0;

             html += `<tr><td>${produto}</td><td class="numeric">${formatPercent(realizado1)}</td>`;

             let realizado2 = 0, quilos2 = 0, caixas2 = 0;
             let diffPerc = -realizado1; // Assume que per√≠odo 2 √© 0 se n√£o encontrado
             let diffKg = -quilos1;
             let diffCx = -Math.round(caixas1);
             let melhorTurno = `${info1.turno} ${info1.turno === 'Turno 1' ? 'üîµ' : 'üü¢'}`; // Default: Per√≠odo 1 vence se 2 n√£o existe
             let classeMelhor = 'negativo'; // Tende a negativo pois P2 est√° ausente
             let prodComp = { produto: produto, perc1: realizado1, perc2: NaN, diffPerc: NaN };

             if (item2) {
                realizado2 = parseFloat(item2.realizado) || 0;
                quilos2 = parseFloat(item2.quilos) || 0;
                caixas2 = parseFloat(item2.caixas) || 0;

                diffPerc = realizado2 - realizado1;
                diffKg = quilos2 - quilos1;
                diffCx = Math.round(caixas2) - Math.round(caixas1);
                prodComp = { produto: produto, perc1: realizado1, perc2: realizado2, diffPerc: diffPerc };

                const threshold = 0.0001; // Pequena margem para empate
                if (diffPerc > threshold) { melhorTurno = `${info2.turno} ${info2.turno === 'Turno 1' ? 'üîµ' : 'üü¢'}`; vitorias2++; classeMelhor = 'positivo'; }
                else if (diffPerc < -threshold) { melhorTurno = `${info1.turno} ${info1.turno === 'Turno 1' ? 'üîµ' : 'üü¢'}`; vitorias1++; classeMelhor = 'negativo'; }
                else { melhorTurno = "Empate ü§î"; empates++; classeMelhor = 'neutro'; }

                const classeDiffPerc = getSignClass(diffPerc);
                const classeDiffKg = getSignClass(diffKg, 0.01); // Margem maior para Kg
                const classeDiffCx = getSignClass(diffCx, 0.5); // Margem para Cx

                html += `<td class="numeric">${formatPercent(realizado2)}</td>`;
                html += `<td class="numeric indicator ${classeDiffPerc}">${getSignIndicator(diffPerc)}${(diffPerc >= 0 ? '+' : '')}${formatPercent(diffPerc)}</td>`;
                html += `<td class="numeric indicator ${classeDiffKg}">${getSignIndicator(diffKg, 0.01)}${(diffKg >= 0 ? '+' : '')}${formatKg(diffKg)}</td>`;
                html += `<td class="numeric indicator ${classeDiffCx}">${getSignIndicator(diffCx, 0.5)}${(diffCx >= 0 ? '+' : '')}${formatCx(diffCx)}</td>`;
                html += `<td class="center ${classeMelhor}">${melhorTurno}</td>`;

             } else { // Produto existe no Per√≠odo 1, mas n√£o no 2
                prodComp = { produto: produto, perc1: realizado1, perc2: NaN, diffPerc: NaN };
                html += `<td class="center">-</td><td colspan="3" class="center"><i>N√£o produzido em ${info2.tituloPeriodo}</i></td><td class="center ${classeMelhor}">${melhorTurno}</td>`;
                // N√£o conta vit√≥ria/derrota formalmente aqui, ou considera P1 vencedor? Depende da regra de neg√≥cio.
                // Por ora, vamos manter a contagem apenas onde h√° compara√ß√£o direta.
             }
             html += `</tr>`;
             comparativoProdutos.push(prodComp);
        }

        // 2. Processa itens exclusivos do Per√≠odo 2
        for (let item2 of dados2.produtos) {
             if (!produtosProcessados.has(item2.produto)) {
                const produto = item2.produto;
                const realizado2 = parseFloat(item2.realizado) || 0;
                const quilos2 = parseFloat(item2.quilos) || 0;
                const caixas2 = parseFloat(item2.caixas) || 0;
                const melhorTurno = `${info2.turno} ${info2.turno === 'Turno 1' ? 'üîµ' : 'üü¢'}`; // P2 vence pois P1 n√£o tem
                const classeMelhor = 'positivo';
                html += `<tr><td>${produto}</td><td class="center">-</td><td class="numeric">${formatPercent(realizado2)}</td><td colspan="3" class="center"><i>N√£o produzido em ${info1.tituloPeriodo}</i></td><td class="center ${classeMelhor}">${melhorTurno}</td></tr>`;
                 // Adiciona ao gr√°fico de diferen√ßa como P2 sendo "infinitamente" melhor (ou apenas mostra P2?)
                 // Para o gr√°fico, vamos focar nos produtos comuns.
                 comparativoProdutos.push({ produto: produto, perc1: NaN, perc2: realizado2, diffPerc: NaN });
             }
        }

        html += "</tbody></table>";

        // Adiciona Resumo Comparativo
        const resumoDiv = document.createElement('div');
        resumoDiv.className = 'summary-section';
        let resumoHtml = `<h4>Resumo Comparativo</h4><ul>`;
        resumoHtml += `<li>${info1.tituloPeriodo} (${info1.turno}) venceu em <strong>${vitorias1}</strong> produto(s).</li>`;
        resumoHtml += `<li>${info2.tituloPeriodo} (${info2.turno}) venceu em <strong>${vitorias2}</strong> produto(s).</li>`;
        resumoHtml += `<li>Empates em <strong>${empates}</strong> produto(s).</li>`;
        let vencedorGeral = "Empate T√©cnico ü§î";
        let classeVencedor = "neutro";
        if (vitorias1 > vitorias2) { vencedorGeral = `${info1.turno} (${info1.tituloPeriodo}) ${info1.turno === 'Turno 1' ? 'üîµ' : 'üü¢'}`; classeVencedor = "negativo"; } // Negativo pq √© o P1
        else if (vitorias2 > vitorias1) { vencedorGeral = `${info2.turno} (${info2.tituloPeriodo}) ${info2.turno === 'Turno 1' ? 'üîµ' : 'üü¢'}`; classeVencedor = "positivo"; } // Positivo pq √© o P2
        resumoHtml += `<li><strong>üèÜ Vencedor Geral (por produtos): <span class="${classeVencedor}">${vencedorGeral}</span></strong></li>`;
        resumoHtml += `</ul>`;
        resumoDiv.innerHTML = resumoHtml;

        // Insere a tabela e depois o resumo
        const tempDiv = document.createElement('div'); // Div tempor√°ria para inserir HTML da tabela
        tempDiv.innerHTML = html;
        container.appendChild(tempDiv); // Adiciona tabela
        container.appendChild(resumoDiv); // Adiciona resumo

        // Prepara dados e desenha gr√°ficos
        const produtosComuns = comparativoProdutos.filter(p => !isNaN(p.perc1) && !isNaN(p.perc2));
        labels.push(...produtosComuns.map(p => p.produto));
        diffData.push(...produtosComuns.map(p => p.diffPerc));

        // Gr√°fico Principal: Comparativo de Barras (Realizado P1 vs Realizado P2)
        const dadosGraficoP1 = produtosComuns.map(p => p.perc1);
        const dadosGraficoP2 = produtosComuns.map(p => p.perc2);
        desenharGraficoPrincipalComparativo(labels, dadosGraficoP1, info1, dadosGraficoP2, info2);

        // Gr√°fico de Diferen√ßa: Barras mostrando a diferen√ßa percentual
        desenharGraficoDiferenca(labels, diffData, info1, info2);
    }


    function mostrarTabelaIndividual(dadosTurno, infoTurno) {
        const container = document.getElementById('resultado');
        let html = "<table><thead><tr><th>Produto</th>";
        const labels = [];
        const metasData = [];
        const realizadosData = [];

        const isMonthly = infoTurno.tipo === 'mensal';
        const isWeekly = infoTurno.tipo === 'semanal';

        // Cabe√ßalhos din√¢micos
        html += `<th class="numeric">Meta (%)</th>`;
        html += `<th class="numeric">${isMonthly ? 'Realizado M√©dio (%)' : 'Realizado (%)'}</th>`;
        html += `<th class="numeric">Dif. (%)</th>`;
        if (isMonthly || isWeekly) {
            const labelTipo = isMonthly ? 'Mensal' : 'Semanal';
            html += `<th class="numeric">Dif. (Kg)</th>`;
            html += `<th class="numeric">Dif. (Cx)</th>`;
            html += `<th class="center">Status ${labelTipo}</th>`;
        } else { // Di√°rio
            html += `<th class="center">Meta Atingida</th>`;
            html += `<th class="numeric">Quilos (Kg)</th>`;
            html += `<th class="numeric">Caixas</th>`;
        }
        html += `</tr></thead><tbody>`;

        for (let item of dadosTurno.produtos) {
             const produto = item.produto;
             const meta = parseFloat(item.meta) || 0;
             const realizado = parseFloat(item.realizado) || 0;
             const quilos = parseFloat(item.quilos) || 0;
             const caixas = parseFloat(item.caixas) || 0;
             const diffPerc = realizado - meta;
             const classeDiffPerc = getSignClass(diffPerc);

             html += `<tr><td>${produto}</td>`;
             html += `<td class="numeric">${formatPercent(meta)}</td>`;
             html += `<td class="numeric">${formatPercent(realizado)}</td>`;
             html += `<td class="numeric indicator ${classeDiffPerc}">${getSignIndicator(diffPerc)}${(diffPerc >= 0 ? '+' : '')}${formatPercent(diffPerc)}</td>`;

             if (isMonthly || isWeekly) {
                let diffKgNum = 0, diffCaixasNum = 0, statusLabel = "N/A", statusClass = "neutro", displayDiffKg = "N/A", displayDiffCx = "N/A";
                const labelTipo = isMonthly ? 'Mensal' : 'Semanal';

                 if (meta > 0 && realizado > 0) {
                     const fator = meta / realizado; // Quanto o realizado precisa mudar para atingir a meta
                     const targetKg = quilos * fator; // KG necess√°rio para atingir a meta % com a produ√ß√£o atual
                     const targetCaixas = caixas * fator;
                     diffKgNum = quilos - targetKg; // Positivo = excedeu KG para a meta %, Negativo = faltou KG
                     diffCaixasNum = Math.round(caixas - targetCaixas); // Arredonda a diferen√ßa de caixas
                     displayDiffKg = `${getSignIndicator(diffKgNum, 0.01)}${(diffKgNum >= 0 ? '+' : '')}${formatKg(diffKgNum)}`;
                     displayDiffCx = `${getSignIndicator(diffCaixasNum, 0.5)}${(diffCaixasNum >= 0 ? '+' : '')}${formatCx(diffCaixasNum)}`;
                 } else if (meta == 0 && realizado == 0) {
                      diffKgNum = 0; diffCaixasNum = 0; displayDiffKg = "<i class='neutro'></i>+0,00"; displayDiffCx = "<i class='neutro'></i>+0";
                 } else if (meta > 0 && realizado == 0) {
                      diffKgNum = -Infinity; diffCaixasNum = -Infinity; displayDiffKg = "<i class='negativo'></i>(Falta Total)"; displayDiffCx = "<i class='negativo'></i>(Falta Total)";
                 } else if (meta == 0 && realizado > 0) { // Excedente puro
                      diffKgNum = quilos; diffCaixasNum = Math.round(caixas); displayDiffKg = `<i class='positivo'></i>+${formatKg(quilos)}`; displayDiffCx = `<i class='positivo'></i>+${formatCx(caixas)}`;
                 }

                 // Status baseado na performance % e KG/CX
                 if (Math.abs(diffPerc) < 0.0001 && Math.abs(diffKgNum) < 0.01) {
                      statusLabel = `üéØ Na Meta ${labelTipo}`; statusClass = "neutro";
                 } else if (diffPerc > 0 || diffKgNum > 0) { // Se a % ou KG/CX for positivo
                      statusLabel = `‚úÖ Acima Meta ${labelTipo}`; statusClass = "positivo";
                 } else {
                      statusLabel = `‚ùå Abaixo Meta ${labelTipo}`; statusClass = "negativo";
                 }

                 html += `<td class="numeric ${getSignClass(diffKgNum, 0.01)}">${displayDiffKg}</td>`;
                 html += `<td class="numeric ${getSignClass(diffCaixasNum, 0.5)}">${displayDiffCx}</td>`;
                 html += `<td class="center ${statusClass}">${statusLabel}</td>`;

             } else { // Di√°rio
                const atingiu = realizado >= meta;
                const metaStatusIcon = atingiu ? '<span class="positivo">‚úÖ Sim</span>' : '<span class="negativo">‚ùå N√£o</span>';
                html += `<td class="center">${metaStatusIcon}</td>`;
                html += `<td class="numeric">${formatKg(quilos)}</td>`;
                html += `<td class="numeric">${formatCx(caixas)}</td>`;
             }
             html += `</tr>`;
             labels.push(produto);
             metasData.push(meta);
             realizadosData.push(realizado);
        }
        html += "</tbody></table>";

        const tempDiv = document.createElement('div');
        tempDiv.innerHTML = html;
        container.appendChild(tempDiv); // Adiciona a tabela ao resultado

        // Desenhar gr√°fico Meta vs Realizado
        desenharGraficoPrincipalIndividual(labels, metasData, realizadosData, infoTurno);

        // Mostrar an√°lise de RI se for mensal e tiver o dado
        if (isMonthly && infoTurno.rendimento_industrial !== null && !isNaN(infoTurno.rendimento_industrial)) {
            mostrarAnaliseRI(infoTurno.rendimento_industrial, infoTurno, null, null); // Passa null para o segundo per√≠odo
        }
    }

    // --- Fun√ß√µes de Desenho de Gr√°ficos ---

    function desenharGraficoPrincipalIndividual(labels, metas, realizados, infoTurno) {
        const container = document.getElementById("graficoPrincipalContainer");
        const canvas = document.getElementById("graficoPrincipal");
        const tituloH4 = document.getElementById("graficoPrincipalTitulo");
        container.style.display = "block";
        const ctx = canvas.getContext('2d');
        if (graficoPrincipalInstancia) { graficoPrincipalInstancia.destroy(); }

        const tipoGrafico = infoTurno.tipo.charAt(0).toUpperCase() + infoTurno.tipo.slice(1);
        const turnoLabel = infoTurno.turno;
        tituloH4.textContent = `Rendimento ${tipoGrafico} ${turnoLabel}: Meta vs Realizado (%)`;

        const corRealizado = turnoLabel.includes("1") ? 'rgba(0, 123, 255, 0.7)' : 'rgba(40, 167, 69, 0.7)'; // Azul T1, Verde T2
        const borderRealizado = turnoLabel.includes("1") ? 'rgba(0, 123, 255, 1)' : 'rgba(40, 167, 69, 1)';

        graficoPrincipalInstancia = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: labels,
                datasets: [
                    {
                        label: 'Meta (%)',
                        data: metas,
                        backgroundColor: 'rgba(255, 193, 7, 0.6)', // Amarelo para meta
                        borderColor: 'rgba(255, 193, 7, 1)',
                        borderWidth: 1,
                        order: 2 // Desenha meta atr√°s
                    },
                    {
                        label: 'Realizado (%)',
                        data: realizados,
                        backgroundColor: corRealizado,
                        borderColor: borderRealizado,
                        borderWidth: 1,
                        order: 1 // Desenha realizado na frente
                    }
                ]
            },
            options: commonChartOptions(tituloH4.textContent) // Passa o t√≠tulo para as op√ß√µes
        });
    }

    function desenharGraficoPrincipalComparativo(labels, data1, info1, data2, info2) {
        const container = document.getElementById("graficoPrincipalContainer");
        const canvas = document.getElementById("graficoPrincipal");
        const tituloH4 = document.getElementById("graficoPrincipalTitulo");
        container.style.display = "block";
        const ctx = canvas.getContext('2d');
        if (graficoPrincipalInstancia) { graficoPrincipalInstancia.destroy(); }

        const tipoGraficoComp = info1.tipo.charAt(0).toUpperCase() + info1.tipo.slice(1);
        tituloH4.textContent = `Comparativo ${tipoGraficoComp}: ${info1.turno} vs ${info2.turno} (% Realizado)`;

        const cor1 = info1.turno === 'Turno 1' ? 'rgba(0, 123, 255, 0.7)' : 'rgba(40, 167, 69, 0.7)';
        const border1 = info1.turno === 'Turno 1' ? 'rgba(0, 123, 255, 1)' : 'rgba(40, 167, 69, 1)';
        const cor2 = info2.turno === 'Turno 1' ? 'rgba(0, 123, 255, 0.7)' : 'rgba(40, 167, 69, 0.7)'; // Pode precisar de cor diferente se for mesmo turno
        const border2 = info2.turno === 'Turno 1' ? 'rgba(0, 123, 255, 1)' : 'rgba(40, 167, 69, 1)';
        // Ajuste de cor se a compara√ß√£o for do mesmo turno
        let corComparacao2 = cor2;
        let borderComparacao2 = border2;
        if (info1.turno === info2.turno) {
             corComparacao2 = 'rgba(23, 162, 184, 0.7)'; // Usar Cyan para o segundo per√≠odo se o turno for igual
             borderComparacao2 = 'rgba(23, 162, 184, 1)';
        }

        graficoPrincipalInstancia = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: labels,
                datasets: [
                    {
                        label: `${info1.tituloPeriodo} (${info1.turno})`,
                        data: data1,
                        backgroundColor: cor1,
                        borderColor: border1,
                        borderWidth: 1,
                        skipNull: true
                    },
                    {
                        label: `${info2.tituloPeriodo} (${info2.turno})`,
                        data: data2,
                        backgroundColor: corComparacao2,
                        borderColor: borderComparacao2,
                        borderWidth: 1,
                        skipNull: true
                    }
                ]
            },
            options: commonChartOptions(tituloH4.textContent)
        });
    }

    function desenharGraficoRI(ri1, info1, ri2, info2, meta) {
        const container = document.getElementById("graficoRIContainer");
        const canvas = document.getElementById("graficoRI");
        container.style.display = "block"; // Mostra o container
        const ctx = canvas.getContext('2d');
        if (graficoRIInstancia) { graficoRIInstancia.destroy(); }

        const labelsRI = [];
        const dataRI = [];
        const colorsRI = [];
        const bordersRI = [];

        if (ri1 !== null && !isNaN(ri1)) {
            labelsRI.push(`${info1.tituloPeriodo} (${info1.turno})`);
            dataRI.push(ri1);
            colorsRI.push(info1.turno === 'Turno 1' ? 'rgba(0, 123, 255, 0.7)' : 'rgba(40, 167, 69, 0.7)');
            bordersRI.push(info1.turno === 'Turno 1' ? 'rgba(0, 123, 255, 1)' : 'rgba(40, 167, 69, 1)');
        }
        if (ri2 !== null && !isNaN(ri2)) {
            labelsRI.push(`${info2.tituloPeriodo} (${info2.turno})`);
            dataRI.push(ri2);
             // Cor diferente se for mesmo turno
            let cor2 = info2.turno === 'Turno 1' ? 'rgba(0, 123, 255, 0.7)' : 'rgba(40, 167, 69, 0.7)';
            let border2 = info2.turno === 'Turno 1' ? 'rgba(0, 123, 255, 1)' : 'rgba(40, 167, 69, 1)';
            if (info1 && info1.turno === info2.turno) { // Verifica se info1 existe
                cor2 = 'rgba(23, 162, 184, 0.7)'; // Cyan
                border2 = 'rgba(23, 162, 184, 1)';
            }
            colorsRI.push(cor2);
            bordersRI.push(border2);
        }

        graficoRIInstancia = new Chart(ctx, {
            type: 'bar', // Usar barra para os RIs
            data: {
                labels: labelsRI,
                datasets: [
                    {
                        label: 'Rendimento Industrial (%)',
                        data: dataRI,
                        backgroundColor: colorsRI,
                        borderColor: bordersRI,
                        borderWidth: 1
                    },
                    {
                        label: 'Meta RI (%)',
                        data: labelsRI.map(() => meta), // Repete a meta para cada label
                        type: 'line', // Linha para a meta
                        borderColor: 'rgba(255, 193, 7, 1)', // Amarelo
                        backgroundColor: 'transparent',
                        borderWidth: 2,
                        pointRadius: 0, // Sem pontos na linha
                        fill: false,
                        tension: 0.1,
                        order: -1 // Desenha a linha por cima das barras
                    }
                ]
            },
            options: commonChartOptions(`Rendimento Industrial (RI): Meta ${formatPercent(meta)}`)
        });
    }

    function desenharGraficoDiferenca(labels, diffData, info1, info2) {
        const container = document.getElementById("graficoDiferencaContainer");
        const canvas = document.getElementById("graficoDiferenca");
        container.style.display = "block"; // Mostra o container
        const ctx = canvas.getContext('2d');
        if (graficoDiferencaInstancia) { graficoDiferencaInstancia.destroy(); }

        const backgroundColors = diffData.map(d => d > 0 ? 'rgba(40, 167, 69, 0.7)' : (d < 0 ? 'rgba(220, 53, 69, 0.7)' : 'rgba(108, 117, 125, 0.7)')); // Verde/Vermelho/Cinza
        const borderColors = diffData.map(d => d > 0 ? 'rgba(40, 167, 69, 1)' : (d < 0 ? 'rgba(220, 53, 69, 1)' : 'rgba(108, 117, 125, 1)'));

        graficoDiferencaInstancia = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: labels,
                datasets: [{
                    label: `Diferen√ßa % (${info2.tituloPeriodo} vs ${info1.tituloPeriodo})`,
                    data: diffData,
                    backgroundColor: backgroundColors,
                    borderColor: borderColors,
                    borderWidth: 1
                }]
            },
            options: commonChartOptions(`Diferen√ßa de Rendimento por Produto (%)`)
        });
    }

    // --- Fun√ß√µes de Navega√ß√£o e Controle ---
    function voltarMenu() {
        destruirGraficos();
        document.querySelector(".menu").style.display = 'block';
        document.querySelector(".voltar").style.display = 'none';
        document.getElementById("info").style.display = 'none';
        document.getElementById("contentArea").style.display = 'none';
        document.getElementById("resultado").innerHTML = ""; // Limpa tabelas e resumos
        document.querySelector('.btn-pdf-visao').style.display = 'none';
        document.getElementById('seletorPeriodoContainer').style.display = 'none';
        document.getElementById('seletores').innerHTML = ''; // Limpa seletores din√¢micos
        document.getElementById("status").style.display = 'none'; // Esconde status
        tipoAnaliseAtual = null;
        dados = {}; // Limpa dados
    }

    function criarSeletor(id, label, tipo = 'date', opcoes = null) {
        const itemDiv = document.createElement('div');
        itemDiv.className = 'seletor-item';
        itemDiv.innerHTML = `<label for="${id}">${label}:</label>`;

        if (tipo === 'date') {
            itemDiv.innerHTML += `<input type="date" id="${id}" name="${id}">`;
        } else if (tipo === 'select') {
            const select = document.createElement('select');
            select.id = id;
            select.name = id;
            select.innerHTML = '<option value="">Carregando...</option>'; // Default
            itemDiv.appendChild(select);
            // Se op√ß√µes forem passadas diretamente (menos comum aqui, populado depois)
            if (opcoes) {
                 select.innerHTML = '<option value="">Selecione...</option>';
                 opcoes.forEach(opt => {
                     const option = document.createElement('option');
                     option.value = opt.value;
                     option.textContent = opt.text;
                     select.appendChild(option);
                 });
            }
        }
        return itemDiv;
    }

    function adicionarSeletoresNecessarios(tipo) {
        const container = document.getElementById('seletores');
        container.innerHTML = ''; // Limpa seletores anteriores
        let grupo1 = document.createElement('div');
        grupo1.className = 'seletor-grupo';

        if (tipo.includes('diario') || tipo.includes('comparar_dia')) {
             grupo1.appendChild(criarSeletor('inputData1', 'Data Per√≠odo 1'));
             if (tipo === 'comparar_dias_turno') { // Comparar dias do mesmo turno
                 container.appendChild(grupo1);
                 let divVs = document.createElement('div'); divVs.className='seletor-divisor'; divVs.textContent = 'VS'; container.appendChild(divVs);
                 let grupo2 = document.createElement('div'); grupo2.className = 'seletor-grupo';
                 grupo2.appendChild(criarSeletor('inputData2', 'Data Per√≠odo 2'));
                 grupo2.appendChild(criarSeletor('selectTurnoCompDia', 'Turno', 'select')); // Selecionar o turno para a compara√ß√£o
                 container.appendChild(grupo2);
                 popularSelectTurno('selectTurnoCompDia'); // Adiciona T1/T2
             } else { // An√°lise di√°ria individual ou T1 vs T2
                 container.appendChild(grupo1);
             }
        } else if (tipo.includes('semanal') || tipo.includes('comparar_semana')) {
            grupo1.appendChild(criarSeletor('selectSemana1', 'Semana Per√≠odo 1', 'select'));
            popularSelectSemana('selectSemana1');
            // Adicionar compara√ß√£o de semanas T1 vs T2 ou mesmo turno (se necess√°rio no futuro)
            container.appendChild(grupo1);
        } else if (tipo.includes('mensal') || tipo.includes('comparar_mes')) {
             grupo1.appendChild(criarSeletor('selectAno1', 'Ano Per√≠odo 1', 'select'));
             grupo1.appendChild(criarSeletor('selectMes1', 'M√™s Per√≠odo 1', 'select'));
             popularSelectAnoMes('selectAno1', 'selectMes1'); // Popula Ano 1 e configura M√™s 1

             if (tipo === 'comparar_meses_turno') { // Comparar meses do mesmo turno
                 container.appendChild(grupo1);
                 let divVs = document.createElement('div'); divVs.className='seletor-divisor'; divVs.textContent = 'VS'; container.appendChild(divVs);
                 let grupo2 = document.createElement('div'); grupo2.className = 'seletor-grupo';
                 grupo2.appendChild(criarSeletor('selectAno2', 'Ano Per√≠odo 2', 'select'));
                 grupo2.appendChild(criarSeletor('selectMes2', 'M√™s Per√≠odo 2', 'select'));
                 grupo2.appendChild(criarSeletor('selectTurnoCompMes', 'Turno', 'select')); // Selecionar Turno
                 container.appendChild(grupo2);
                 popularSelectAnoMes('selectAno2', 'selectMes2'); // Popula Ano 2 e configura M√™s 2
                 popularSelectTurno('selectTurnoCompMes'); // Adiciona T1/T2
             } else if (tipo === 'comparar_mes_ano') { // Comparar mesmo m√™s, anos diferentes
                 container.appendChild(grupo1); // Grupo 1 j√° tem Ano1/M√™s1
                 let divVs = document.createElement('div'); divVs.className='seletor-divisor'; divVs.textContent = 'VS'; container.appendChild(divVs);
                 let grupo2 = document.createElement('div'); grupo2.className = 'seletor-grupo';
                 grupo2.appendChild(criarSeletor('selectAno2', 'Ano Per√≠odo 2', 'select'));
                 grupo2.appendChild(criarSeletor('selectTurnoCompMesAno', 'Turno', 'select')); // Selecionar Turno
                 container.appendChild(grupo2);
                 // M√™s √© o mesmo do per√≠odo 1, ent√£o s√≥ popula Ano 2 e Turno
                 popularSelectAnoMes('selectAno2', null); // S√≥ popula anos
                 popularSelectTurno('selectTurnoCompMesAno');
             } else { // An√°lise mensal individual ou T1 vs T2
                 container.appendChild(grupo1);
             }
        }
    }

    function selecionarPeriodo(tipo) {
        tipoAnaliseAtual = tipo;
        //console.log("Selecionando per√≠odo para:", tipoAnaliseAtual);
        document.querySelector(".menu").style.display = 'none';
        document.getElementById("contentArea").style.display = 'none';
        document.getElementById("info").style.display = 'none';
        destruirGraficos();
        document.getElementById("resultado").innerHTML = ''; // Limpa conte√∫do anterior

        const seletorContainer = document.getElementById('seletorPeriodoContainer');
        const tituloSpan = document.getElementById('tipoAnaliseSelecionada');

        // Mapeia tipo para t√≠tulo leg√≠vel
        const titulos = {
             'diario1': 'Di√°ria Turno 1', 'diario2': 'Di√°ria Turno 2',
             'semanal1': 'Semanal Turno 1', 'semanal2': 'Semanal Turno 2',
             'mensal1': 'Mensal Turno 1', 'mensal2': 'Mensal Turno 2',
             'comparar_dia': 'Comparativo Di√°rio (T1 vs T2)',
             'comparar_dias_turno': 'Comparativo Di√°rio (Mesmo Turno)',
             'comparar_semana': 'Comparativo Semanal (T1 vs T2)',
             'comparar_mes': 'Comparativo Mensal (T1 vs T2)',
             'comparar_meses_turno': 'Comparativo Mensal (Mesmo Turno)',
             'comparar_mes_ano': 'Comparativo Mensal (Ano vs Ano)'
        };
        tituloSpan.textContent = titulos[tipo] || 'An√°lise';

        // Adiciona os seletores corretos
        adicionarSeletoresNecessarios(tipo);

        seletorContainer.style.display = 'block'; // Mostra a √°rea de sele√ß√£o
        document.querySelector(".voltar").style.display = 'inline-block';
    }

    function cancelarSelecao() {
        document.getElementById('seletorPeriodoContainer').style.display = 'none';
        voltarMenu();
    }

    function setStatus(message, type = 'loading') { // type: loading, error, success, info
        const statusDiv = document.getElementById("status");
        statusDiv.textContent = message;
        statusDiv.className = type; // Remove classes antigas e aplica a nova
        statusDiv.style.display = 'block';
    }

    // Fun√ß√£o para obter o nome do arquivo baseado nos seletores
    function construirNomeArquivo(tipoBase, params) {
        // tipoBase: 'diario', 'semanal', 'mensal'
        // params: { data, semanaId, ano, mes, turno }
        let nomeBase = '';
        if (tipoBase === 'diario') {
            if (!params.data) return null;
            const dateObj = new Date(params.data + 'T00:00:00Z');
            const diaSemanaNome = dateObj.toLocaleDateString('pt-BR', { weekday: 'long', timeZone: 'UTC' }).toLowerCase();
            const diaNum = String(dateObj.getUTCDate()).padStart(2, '0');
            const mesNum = String(dateObj.getUTCMonth() + 1).padStart(2, '0');
            const anoCurto = String(dateObj.getUTCFullYear()).substring(2);
            // Tenta os dois formatos (com e sem 'feira')
            const baseSemFeira = `${diaSemanaNome.replace('-feira', '')}.${diaNum}.${mesNum}.${anoCurto}`;
            const baseComFeira = `${diaSemanaNome.replace('-', '.feira.')}.${diaNum}.${mesNum}.${anoCurto}`; // Corre√ß√£o aqui
             const nomeSem = `${baseSemFeira}.${params.turno}.json`;
             const nomeCom = `${baseComFeira}.${params.turno}.json`;
             //console.log("Tentando arquivos di√°rios:", nomeSem, nomeCom);
             if (arquivosDisponiveis.includes(nomeSem)) return nomeSem;
             if (arquivosDisponiveis.includes(nomeCom)) return nomeCom;
             return null; // N√£o encontrado

        } else if (tipoBase === 'semanal') {
            if (!params.semanaId) return null;
            nomeBase = `${params.semanaId}.${params.turno}.json`;
        } else if (tipoBase === 'mensal') {
            if (!params.ano || !params.mes) return null;
            const anoCurto = params.ano.substring(2);
            const mesPad = String(params.mes).padStart(2, '0');
            nomeBase = `mensal.${mesPad}.${anoCurto}.${params.turno}.json`;
        }
        //console.log("Construindo nome:", nomeBase);
        return arquivosDisponiveis.includes(nomeBase) ? nomeBase : null;
    }

    async function carregarDadosSelecionados() {
        setStatus("‚è≥ Carregando dados selecionados...", 'loading');
        document.getElementById('seletorPeriodoContainer').style.display = 'none';
        destruirGraficos(); // Limpa gr√°ficos antigos
        document.getElementById("resultado").innerHTML = ""; // Limpa resultados antigos

        let nomeArquivo1 = null, nomeArquivo2 = null;
        let info1 = null, info2 = null;
        dados = {}; // Limpa dados da visualiza√ß√£o anterior

        try {
            let params1 = { turno: 'turno1' }; // Default para T1
            let params2 = { turno: 'turno2' }; // Default para T2
            let tipoBase = ''; // diario, semanal, mensal

            // --- Coleta par√¢metros dos seletores ---
            if (tipoAnaliseAtual.includes('diario') || tipoAnaliseAtual.includes('comparar_dia')) tipoBase = 'diario';
            if (tipoAnaliseAtual.includes('semanal') || tipoAnaliseAtual.includes('comparar_semana')) tipoBase = 'semanal';
            if (tipoAnaliseAtual.includes('mensal') || tipoAnaliseAtual.includes('comparar_mes')) tipoBase = 'mensal';

            // Per√≠odo 1
            if (document.getElementById('inputData1')) params1.data = document.getElementById('inputData1').value;
            if (document.getElementById('selectSemana1')) params1.semanaId = document.getElementById('selectSemana1').value;
            if (document.getElementById('selectAno1')) params1.ano = document.getElementById('selectAno1').value;
            if (document.getElementById('selectMes1')) params1.mes = document.getElementById('selectMes1').value;

             // Determina o turno para o per√≠odo 1 (se n√£o for compara√ß√£o T1 vs T2)
             if (tipoAnaliseAtual.endsWith('1')) params1.turno = 'turno1';
             else if (tipoAnaliseAtual.endsWith('2')) params1.turno = 'turno2';
             // Para compara√ß√µes do mesmo turno, pega o turno selecionado
             else if (tipoAnaliseAtual === 'comparar_dias_turno' && document.getElementById('selectTurnoCompDia')) params1.turno = document.getElementById('selectTurnoCompDia').value;
             else if (tipoAnaliseAtual === 'comparar_meses_turno' && document.getElementById('selectTurnoCompMes')) params1.turno = document.getElementById('selectTurnoCompMes').value;
             else if (tipoAnaliseAtual === 'comparar_mes_ano' && document.getElementById('selectTurnoCompMesAno')) params1.turno = document.getElementById('selectTurnoCompMesAno').value;

             // Per√≠odo 2 (Apenas para compara√ß√µes espec√≠ficas)
             if (tipoAnaliseAtual === 'comparar_dias_turno') {
                 params2.data = document.getElementById('inputData2').value;
                 params2.turno = params1.turno; // Mesmo turno
             } else if (tipoAnaliseAtual === 'comparar_meses_turno') {
                 params2.ano = document.getElementById('selectAno2').value;
                 params2.mes = document.getElementById('selectMes2').value;
                 params2.turno = params1.turno; // Mesmo turno
             } else if (tipoAnaliseAtual === 'comparar_mes_ano') {
                 params2.ano = document.getElementById('selectAno2').value;
                 params2.mes = params1.mes; // Mesmo m√™s
                 params2.turno = params1.turno; // Mesmo turno
             } else if (tipoAnaliseAtual.includes('comparar_') && !tipoAnaliseAtual.includes('_turno') && !tipoAnaliseAtual.includes('_ano')) {
                 // Compara√ß√µes T1 vs T2 (dia, semana, mes) - usam os mesmos params de data/semana/mes, s√≥ muda o turno
                 params2 = { ...params1, turno: 'turno2' }; // Copia params1 e define turno2
             } else {
                  params2 = null; // N√£o √© uma compara√ß√£o que precisa de params2 expl√≠citos
             }

            // --- Constr√≥i nomes de arquivo ---
            nomeArquivo1 = construirNomeArquivo(tipoBase, params1);
            if (params2) {
                nomeArquivo2 = construirNomeArquivo(tipoBase, params2);
            } else if (tipoAnaliseAtual.endsWith('2')) { // Se for an√°lise individual do Turno 2
                 nomeArquivo1 = construirNomeArquivo(tipoBase, { ...params1, turno: 'turno2' }); // Ajusta nomeArquivo1 para T2
            }

            // --- Carrega Dados ---
            const promessas = [];
            const arquivosACarregar = [];

            if (nomeArquivo1) arquivosACarregar.push({ nome: nomeArquivo1, key: 'periodo1' });
             // S√≥ carrega o segundo se for uma compara√ß√£o e o arquivo existir
            if (params2 && nomeArquivo2) arquivosACarregar.push({ nome: nomeArquivo2, key: 'periodo2' });
            // Se for compara√ß√£o T1 vs T2 padr√£o e o nome do arquivo 2 foi constru√≠do
            else if (tipoAnaliseAtual.includes('comparar_') && !params2 && params1.turno === 'turno1') {
                let nomeT2 = construirNomeArquivo(tipoBase, {...params1, turno: 'turno2'});
                if(nomeT2) arquivosACarregar.push({ nome: nomeT2, key: 'periodo2' });
            }

            if (arquivosACarregar.length === 0 || (arquivosACarregar.length === 1 && tipoAnaliseAtual.includes('comparar_'))) {
                 // Verifica se falta arquivo para compara√ß√£o
                 let msgErro = "Nenhum arquivo de dados encontrado para a sele√ß√£o.";
                 if (tipoAnaliseAtual.includes('comparar_')) {
                      if (!nomeArquivo1 && !nomeArquivo2) msgErro = "Arquivos para ambos os per√≠odos da compara√ß√£o n√£o encontrados.";
                      else if (!nomeArquivo1) msgErro = `Arquivo para o ${params1.turno || 'primeiro per√≠odo'} n√£o encontrado.`;
                      else if (!nomeArquivo2 && (params2 || tipoAnaliseAtual !== 'comparar_dias_turno')) msgErro = `Arquivo para o ${params2?.turno || 'segundo per√≠odo/turno'} n√£o encontrado.`;
                 }
                throw new Error(msgErro);
            }

            for (const arq of arquivosACarregar) {
                promessas.push(
                    fetch(arq.nome)
                        .then(res => {
                            if (!res.ok) return Promise.reject(`Erro HTTP ${res.status} ao carregar ${arq.nome}`);
                            return res.json();
                        })
                        .then(d => {
                            // Armazena dados brutos e informa√ß√µes extra√≠das
                            dados[arq.key] = d; // d cont√©m { rendimento_industrial: VALOR, produtos: [...] } ou apenas { produtos: [...] }
                            const infoBase = extrairInfo(arq.nome);
                            // Adiciona o RI lido do JSON ao objeto info
                            infoBase.rendimento_industrial = d.rendimento_industrial !== undefined ? parseFloat(d.rendimento_industrial) : null;
                            // Adiciona a lista de produtos ao info para f√°cil acesso (se necess√°rio)
                            // infoBase.produtos = d.produtos; // Opcional, dados j√° est√£o em dados[arq.key]

                            if (arq.key === 'periodo1') info1 = infoBase;
                            if (arq.key === 'periodo2') info2 = infoBase;
                        })
                        .catch(err => {
                            console.error(`Falha ao carregar ou processar ${arq.nome}:`, err);
                            throw new Error(`N√£o foi poss√≠vel carregar dados de ${arq.nome}. Verifique o arquivo e o console.`);
                        })
                );
            }

            await Promise.all(promessas);

            // --- Exibe Resultados ---
             if (!info1 && !info2) throw new Error("Falha ao carregar informa√ß√µes dos arquivos.");

             document.getElementById("contentArea").style.display = 'block'; // Mostra √°rea de conte√∫do
             document.querySelector('.btn-pdf-visao').style.display = 'inline-block'; // Mostra bot√£o PDF

             if (info1 && info2) { // Modo Comparativo
                 mostrarCabecalho(info1, info2, tipoAnaliseAtual);
                 // Verifica se tem RI para comparar (somente em an√°lises mensais)
                 if (info1.tipo === 'mensal' && (info1.rendimento_industrial !== null || info2.rendimento_industrial !== null)) {
                      mostrarAnaliseRI(info1.rendimento_industrial, info1, info2.rendimento_industrial, info2);
                 }
                 mostrarTabelaComparativa(dados.periodo1, info1, dados.periodo2, info2, tipoAnaliseAtual);
             } else if (info1) { // Modo Individual (pode ser T1 ou T2 dependendo do tipoAnaliseAtual)
                 mostrarCabecalho(info1);
                 mostrarTabelaIndividual(dados.periodo1, info1);
             } else { // Caso inesperado
                  throw new Error("N√£o foi poss√≠vel determinar o modo de exibi√ß√£o.");
             }

            setStatus("Dados carregados com sucesso!", 'success');
            setTimeout(() => { setStatus("", 'info'); statusDiv.style.display = 'none'; }, 2000); // Esconde ap√≥s 2s

        } catch (error) {
            console.error("Erro detalhado ao carregar/processar dados:", error);
            destruirGraficos();
            document.getElementById("contentArea").style.display = 'block'; // Mostra √°rea para exibir o erro
            document.getElementById("info").innerHTML = `‚ùå Erro na Opera√ß√£o`;
            document.getElementById("info").style.display = 'block';
            document.getElementById("resultado").innerHTML = `<p class="negativo" style="text-align: center; padding: 20px;">${error.message}</p>`;
            document.querySelector('.btn-pdf-visao').style.display = 'none';
            setStatus(`Erro: ${error.message}`, 'error');
        }
    }

    // --- Fun√ß√µes de Preenchimento de Seletores ---
    let _cacheSeletores = { anos: [], meses: new Map(), semanas: [] }; // Cache para evitar reprocessamento

    function processarArquivosParaSeletores() {
        if (_cacheSeletores.anos.length > 0) return; // J√° processado

        const anosSet = new Set();
        const mesesMap = new Map(); // ano -> Map(mesNum -> mesNome)
        const semanasMap = new Map(); // idSemana -> { texto, dataOrdenacao }

        arquivosDisponiveis.forEach(nomeArquivo => {
            const info = extrairInfo(nomeArquivo);
            if (!info || info.tipo === 'N/A') return;

            if (info.tipo === 'semanal') {
                 const idSemana = nomeArquivo.replace('.turno1.json', '').replace('.turno2.json', '');
                 if (!semanasMap.has(idSemana) && info.periodoSemana && info.mes && info.ano) {
                     try {
                          const primeiroDia = parseInt(info.periodoSemana.split(' a ')[0]);
                          const dataOrdenacao = new Date(parseInt(info.ano), parseInt(info.mes) - 1, primeiroDia);
                          semanasMap.set(idSemana, { texto: info.tituloPeriodo, data: dataOrdenacao });
                     } catch (e) { console.warn("Erro ao processar data da semana:", nomeArquivo, e); }
                 }
            } else if (info.tipo === 'mensal') {
                 if (info.ano && info.mes) {
                     anosSet.add(info.ano);
                     if (!mesesMap.has(info.ano)) mesesMap.set(info.ano, new Map());
                     if (!mesesMap.get(info.ano).has(info.mes) && info.tituloPeriodo) {
                         mesesMap.get(info.ano).set(info.mes, info.tituloPeriodo.split('/')[0]); // Guarda nome do m√™s
                     }
                 }
            }
        });

        _cacheSeletores.anos = [...anosSet].sort().reverse();
        _cacheSeletores.meses = mesesMap;
        _cacheSeletores.semanas = [...semanasMap.entries()]
            .sort(([, a], [, b]) => b.data - a.data) // Mais recentes primeiro
            .map(([id, info]) => ({ value: id, text: info.texto }));

        //console.log("Cache de seletores populado:", _cacheSeletores);
    }

    function popularSelectTurno(selectId) {
        const select = document.getElementById(selectId);
        if (!select) return;
        select.innerHTML = '<option value="">Selecione Turno...</option>';
        select.innerHTML += '<option value="turno1">Turno 1 üîµ</option>';
        select.innerHTML += '<option value="turno2">Turno 2 üü¢</option>';
    }


    function popularSelectSemana(selectId) {
        const select = document.getElementById(selectId);
        if (!select) return;
        select.innerHTML = '<option value="">Selecione Semana...</option>';
        if (_cacheSeletores.semanas.length === 0) {
            select.innerHTML = '<option value="">Nenhuma semana encontrada</option>';
            return;
        }
        _cacheSeletores.semanas.forEach(sem => {
            const option = document.createElement('option');
            option.value = sem.value;
            option.textContent = sem.text;
            select.appendChild(option);
        });
    }

    function popularSelectAnoMes(selectAnoId, selectMesId) {
        const selectAno = document.getElementById(selectAnoId);
        const selectMes = selectMesId ? document.getElementById(selectMesId) : null;
        if (!selectAno) return;

        selectAno.innerHTML = '<option value="">Selecione Ano...</option>';
        if (_cacheSeletores.anos.length === 0) {
             selectAno.innerHTML = '<option value="">Nenhum ano encontrado</option>';
             if (selectMes) selectMes.innerHTML = '<option value="">Selecione o Ano</option>';
             return;
        }

        _cacheSeletores.anos.forEach(ano => {
            const option = document.createElement('option');
            option.value = ano;
            option.textContent = ano;
            selectAno.appendChild(option);
        });

        if (selectMes) {
             selectMes.innerHTML = '<option value="">Selecione o Ano</option>'; // Estado inicial do select de m√™s
             selectAno.addEventListener('change', () => {
                 const anoSelecionado = selectAno.value;
                 selectMes.innerHTML = '<option value="">Selecione M√™s...</option>';
                 if(anoSelecionado && _cacheSeletores.meses.has(anoSelecionado)) {
                     const mesesDoAno = [..._cacheSeletores.meses.get(anoSelecionado).entries()]
                         .sort(([a], [b]) => parseInt(a) - parseInt(b)); // Ordena por n√∫mero do m√™s
                      mesesDoAno.forEach(([mesNum, mesNome]) => {
                          const option = document.createElement('option');
                          option.value = mesNum;
                          option.textContent = mesNome;
                          selectMes.appendChild(option);
                      });
                 } else if (anoSelecionado) {
                     selectMes.innerHTML = '<option value="">Nenhum m√™s encontrado</option>';
                 } else {
                      selectMes.innerHTML = '<option value="">Selecione o Ano</option>';
                 }
             });
        }
    }

    async function iniciar() {
        setStatus("‚è≥ Carregando manifesto de arquivos...", 'loading');
        try {
            const response = await fetch("index.json?t=" + Date.now()); // Evita cache do index.json
            if (!response.ok) throw new Error(`Erro ao carregar index.json: ${response.status} ${response.statusText}`);
            const listaManifesto = await response.json();
            arquivosDisponiveis = listaManifesto.arquivos || [];

            if (arquivosDisponiveis.length === 0) {
                 throw new Error("Nenhum arquivo encontrado no manifesto index.json.");
            }

            processarArquivosParaSeletores(); // Processa os arquivos para popular os seletores depois
            setStatus("Manifesto carregado. Pronto.", 'success');
            setTimeout(() => document.getElementById("status").style.display = 'none', 1500);

        } catch (error) {
            console.error("Erro cr√≠tico ao iniciar:", error);
            setStatus(`‚ùå Erro cr√≠tico: ${error.message}. Verifique o console e o arquivo index.json.`, 'error');
            // Manter a mensagem de erro vis√≠vel
        }
    }

    // --- Fun√ß√£o de Exporta√ß√£o PDF (Adaptada) ---
    async function exportarPDF_VisaoAtual() {
        const elementToCapture = document.getElementById('contentArea');
        const infoDiv = document.getElementById('info');
        const pdfButton = document.querySelector('.btn-pdf-visao');
        const originalPdfButtonDisplay = pdfButton.style.display;
        const originalChartAnimation = Chart.defaults.animation.duration;

        setStatus("Gerando PDF...", 'loading');
        pdfButton.style.display = 'none'; // Esconder bot√£o
        Chart.defaults.animation.duration = 0; // Desabilitar anima√ß√µes para render r√°pido

        // For√ßar re-render s√≠ncrono (melhor para captura)
        const charts = [graficoPrincipalInstancia, graficoRIInstancia, graficoDiferencaInstancia];
        charts.forEach(chart => { if (chart) chart.update('none'); });

        // Adicionar o t√≠tulo da se√ß√£o 'info' dentro da √°rea de captura para o PDF
        const titleElement = document.createElement('div');
        titleElement.innerHTML = infoDiv.innerHTML; // Copia o conte√∫do do t√≠tulo
        titleElement.className = 'info'; // Aplica a mesma classe para estilo
        titleElement.style.display = 'block'; // Garante visibilidade
        elementToCapture.insertBefore(titleElement, elementToCapture.firstChild); // Insere no in√≠cio

        // Pequeno delay para garantir renderiza√ß√£o ap√≥s desabilitar anima√ß√£o
        await new Promise(resolve => setTimeout(resolve, 150));

        const infoTextContent = infoDiv.textContent || 'Visao_Atual';
        const filename = `relatorio_${infoTextContent.substring(0, 50).replace(/[^a-z0-9]/gi, '_').toLowerCase()}.pdf`;

        const opt = {
          margin:       [0.4, 0.4, 0.4, 0.4], // Margens T, L, B, R em inches
          filename:     filename,
          image:        { type: 'jpeg', quality: 0.97 },
          html2canvas:  {
              scale: 2, // Melhor resolu√ß√£o
              useCORS: true,
              logging: false,
              // Tentar desabilitar anti-aliasing pode deixar fontes piores
          },
          jsPDF:        { unit: 'in', format: 'a4', orientation: 'landscape' }, // Paisagem geralmente melhor
          pagebreak:    {
               mode: ['css', 'avoid-all'], // Evitar quebras onde poss√≠vel
               avoid: ['.chart-container', '.summary-section', 'tr', 'h4', '.info'] // Elementos a manter juntos
           }
        };

        try {
            console.log(`Gerando PDF: ${filename}`);
            await html2pdf().from(elementToCapture).set(opt).save();
            setStatus("PDF gerado com sucesso!", 'success');
            setTimeout(() => setStatus("", 'info'), 2000); // Limpa status
            console.log("PDF gerado com sucesso.");
        } catch (error) {
            console.error("Erro ao gerar PDF:", error);
            setStatus("Ocorreu um erro ao gerar o PDF.", 'error');
            alert("Ocorreu um erro ao gerar o PDF. Verifique o console.");
        } finally {
            // Limpeza p√≥s-captura
            elementToCapture.removeChild(titleElement); // Remove o t√≠tulo clonado
            pdfButton.style.display = originalPdfButtonDisplay; // Restaura bot√£o
            Chart.defaults.animation.duration = originalChartAnimation; // Restaura anima√ß√µes
            // Re-enable dynamic updates if they were stopped (update() is usually enough)
            charts.forEach(chart => { if (chart) chart.update(); });
            console.log("Limpeza p√≥s-PDF conclu√≠da.");
             if (document.getElementById("status").className === 'success') { // Esconde se for sucesso
                  setTimeout(() => document.getElementById("status").style.display = 'none', 1500);
             }
        }
    }

    // --- Inicia a aplica√ß√£o ---
    window.onload = iniciar;

</script>
</body>
</html>
